<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="theme-color" content="#667eea" />
<title>ğŸ¤ Voice Flashcards</title>

<link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIlZvaWNlIEZsYXNoY2FyZHMiLAogICJzaG9ydF9uYW1lIjogIkZsYXNoY2FyZHMiLAogICJzdGFydF91cmwiOiAiLiIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgImJhY2tncm91bmRfY29sb3IiOiAiIzY2N2VlYSIsCiAgInRoZW1lX2NvbG9yIjogIiM2NjdlZWEiLAogICJpY29ucyI6IFt7InNyYyI6ICJkYXRhOmltYWdlL3N2Zyt4bWwsJTNDc3ZnIHhtbG5zPSdodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2Zycgdmlld0JveD0nMCAwIDEwMCAxMDAnJTNFJTNDdGV4dCB5PScuOWVtJyBmb250LXNpemU9JzkwJyUzRSVGMCU5RiU4RSVBNCUzQy90ZXh0JTNFJTNDL3N2ZyUzRSIsICJzaXplcyI6ICIxOTJ4MTkyIiwgInR5cGUiOiAiaW1hZ2Uvc3ZnK3htbCJ9XQp9" />

<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:20px 20px 100px}
body.rtl{direction:rtl}
.container{max-width:600px;margin:0 auto}
.card{background:#fff;border-radius:20px;padding:20px;margin-bottom:20px;box-shadow:0 10px 30px rgba(0,0,0,.2)}
.lang-switcher{position:fixed;top:20px;right:20px;z-index:1000;background:#fff;border-radius:12px;padding:8px;box-shadow:0 4px 12px rgba(0,0,0,.2);display:flex;gap:5px}
.lang-btn{padding:8px 16px;border:none;border-radius:8px;font-weight:700;font-size:14px;cursor:pointer;background:#f3f4f6;color:#666;transition:all 0.3s}
.lang-btn.active{background:#667eea;color:#fff}
.security-badge{display:inline-flex;align-items:center;gap:6px;background:linear-gradient(135deg,#10b981,#059669);color:#fff;padding:8px 16px;border-radius:20px;font-size:13px;font-weight:600;margin-bottom:16px}
.ai-badge{display:inline-flex;align-items:center;gap:6px;background:linear-gradient(135deg,#8b5cf6,#6366f1);color:#fff;padding:8px 16px;border-radius:20px;font-size:13px;font-weight:600;margin-left:8px}
body.rtl .ai-badge{margin-left:0;margin-right:8px}
h1{color:#667eea;margin-bottom:10px}.subtitle{color:#666;font-size:14px}
.ai-selector{margin:16px 0;padding:12px;background:#f3f4f6;border-radius:12px}
.ai-selector select{width:100%;padding:12px;border:2px solid #667eea;border-radius:10px;font-size:16px;font-weight:600;color:#667eea;background:#fff;cursor:pointer}
.input-mode-tabs{display:flex;gap:10px;margin:16px 0}
.input-tab{flex:1;padding:12px;border:2px solid #e0e0e0;border-radius:10px;background:#fff;cursor:pointer;text-align:center;font-weight:600;font-size:14px;transition:all 0.3s}
.input-tab.active{background:#667eea;color:#fff;border-color:#667eea}
.mode-selector{display:flex;gap:10px;margin-top:15px}
.mode-btn{flex:1;padding:12px;border:none;border-radius:10px;font-weight:700;cursor:pointer;font-size:14px}
.mode-btn.active{background:#667eea;color:#fff}.mode-btn.inactive{background:#e0e0e0;color:#666}
.mic-button{width:120px;height:120px;border-radius:50%;border:none;background:#667eea;color:#fff;font-size:48px;cursor:pointer;display:flex;align-items:center;justify-content:center;margin:0 auto;transition:.3s;box-shadow:0 8px 20px rgba(102,126,234,.4)}
.mic-button:disabled{opacity:.6;cursor:not-allowed}.mic-button.listening{background:#ef4444;animation:pulse 1.5s infinite}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
.text-input-container{display:none}
.text-input-container.active{display:block}
.text-input-container textarea{width:100%;min-height:100px;padding:15px;border:2px solid #667eea;border-radius:10px;font-size:16px;font-family:inherit;resize:vertical}
.result-box{padding:12px;border-radius:10px;margin-bottom:15px;white-space:pre-wrap;line-height:1.8;position:relative}
.result-box.question{background:#f3f4f6}.result-box.answer{background:#d1fae5;font-size:15px}.result-box.error{background:#fee2e2;border:2px solid #ef4444}
.label{font-size:12px;font-weight:700;margin-bottom:5px;display:flex;align-items:center;gap:8px}
.speak-btn{background:#667eea;color:#fff;border:none;border-radius:50%;width:32px;height:32px;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;font-size:16px;transition:all 0.3s;box-shadow:0 2px 8px rgba(102,126,234,0.3)}
.speak-btn:hover{background:#5568d3;transform:scale(1.05)}
.speak-btn:active{transform:scale(0.95)}
.speak-btn.speaking{animation:speaking-pulse 0.8s infinite}
@keyframes speaking-pulse{0%,100%{background:#667eea;transform:scale(1)}50%{background:#5568d3;transform:scale(1.1)}}
.btn{width:100%;padding:15px;border:none;border-radius:10px;font-weight:700;font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px}
.btn-primary{background:#667eea;color:#fff}.btn-success{background:#10b981;color:#fff}.btn-warning{background:#fbbf24;color:#92400e}
.api-section{margin:20px 0;padding:16px;background:#f9fafb;border-radius:12px;border-left:4px solid #667eea}
body.rtl .api-section{border-left:none;border-right:4px solid #667eea}
.api-section h4{color:#667eea;margin-bottom:8px}
.flashcard-item{padding:18px;background:#f9fafb;border-radius:10px;margin-bottom:10px;position:relative;padding-right:50px;line-height:1.7}
body.rtl .flashcard-item{padding-right:18px;padding-left:50px}
.delete-btn{position:absolute;top:10px;right:10px;background:#ef4444;color:#fff;border:none;border-radius:50%;width:30px;height:30px;cursor:pointer;font-size:18px}
body.rtl .delete-btn{right:auto;left:10px}
.settings-btn{position:fixed;bottom:20px;right:20px;width:60px;height:60px;border-radius:50%;background:#fff;border:none;box-shadow:0 4px 12px rgba(0,0,0,.3);cursor:pointer;font-size:24px}
body.rtl .settings-btn{right:auto;left:20px}
.input-field{width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:10px;font-size:14px;margin:10px 0}
.practice-card{min-height:150px;display:flex;align-items:center;justify-content:center;background:#f9fafb;border-radius:15px;padding:30px;margin:20px 0;font-size:20px;line-height:1.6;text-align:center}
.security-info{background:#f0f9ff;border-left:4px solid #3b82f6;padding:12px;margin:16px 0;border-radius:8px;font-size:13px;color:#1e40af}
body.rtl .security-info{border-left:none;border-right:4px solid #3b82f6}
.error-details{background:#fee2e2;border-left:4px solid #ef4444;padding:12px;margin:16px 0;border-radius:8px;font-size:12px;color:#991b1b;font-family:monospace;max-height:200px;overflow-y:auto;white-space:pre-wrap}
body.rtl .error-details{border-left:none;border-right:4px solid #ef4444}
.hidden{display:none}@keyframes spin{from{transform:rotate(0)}to{transform:rotate(360deg)}}.loading{animation:spin 1s linear infinite}
.row{display:flex;gap:10px;align-items:center}.grow{flex:1}.small{font-size:12px;color:#666}label{font-size:12px;color:#555;font-weight:600}
.auth-row{display:flex;gap:10px;align-items:center;justify-content:space-between}
.user-pill{background:#eef2ff;color:#4f46e5;border:1px solid:#c7d2fe;border-radius:999px;padding:6px 12px;font-size:12px;font-weight:700}
.ios-warning{background:#fef3c7;border-left:4px solid #f59e0b;padding:12px;margin:16px 0;border-radius:8px;font-size:13px;color:#78350f;line-height:1.5}
body.rtl .ios-warning{border-left:none;border-right:4px solid #f59e0b}
.speech-badge{background:#eef2ff;border:1px solid #c7d2fe;border-radius:8px;padding:8px 12px;font-size:12px;color:#4f46e5;margin-top:10px;display:inline-flex;align-items:center;gap:6px}
</style>
</head>
<body>

<!-- Language Switcher -->
<div class="lang-switcher">
  <button class="lang-btn active" onclick="switchLanguage('en')">EN</button>
  <button class="lang-btn" onclick="switchLanguage('fa')">ÙØ§</button>
</div>

<div class="container">
  <div class="card">
    <div>
      <span class="security-badge" data-i18n="encrypted">ğŸ”’ Encrypted</span>
      <span class="ai-badge" data-i18n="multi-ai">ğŸ¤– Multi-AI</span>
    </div>
    <h1 data-i18n="title">ğŸ¤ Voice Flashcards</h1>
    <p class="subtitle" data-i18n="subtitle">Works on iOS â€¢ Multi-AI Support â€¢ Text-to-Speech</p>

    <div class="ai-selector">
      <select id="aiProvider" onchange="updateAIProvider()">
        <option value="gemini" data-i18n-opt="ai-gemini">ğŸŒŸ Gemini 2.x (FREE)</option>
        <option value="gpt" data-i18n-opt="ai-gpt">âš¡ GPT-4o (Paid)</option>
        <option value="claude" data-i18n-opt="ai-claude">ğŸ§  Claude Sonnet (Paid)</option>
      </select>
    </div>

    <div class="mode-selector">
      <button class="mode-btn active" onclick="setMode('create')"><span data-i18n="create-btn">âœï¸ Create</span></button>
      <button class="mode-btn inactive" onclick="setMode('practice')"><span data-i18n="practice-btn">ğŸ® Practice</span> (<span id="cardCount">0</span>)</button>
    </div>
  </div>

  <!-- iOS Warning -->
  <div id="iosWarning" class="card ios-warning hidden">
    <strong data-i18n="ios-warning-title">âš ï¸ iOS Voice Input Blocked</strong><br><br>
    <span data-i18n="ios-warning-text">iOS is blocking voice input. Please check:<br>â€¢ Settings â†’ Screen Time â†’ Content Restrictions<br>â€¢ Try Text Input mode instead (below)<br><br>This is an iOS system restriction, not an app bug.</span>
  </div>

  <!-- Auth -->
  <div id="authCard" class="card">
    <div class="auth-row">
      <div id="who" class="small" style="color:#667eea" data-i18n="not-signed-in">You are not signed in.</div>
      <div>
        <button id="loginBtn" class="btn btn-primary" style="width:auto;padding:10px 14px;" data-i18n="sign-in">ğŸ”‘ Sign in</button>
        <button id="logoutBtn" class="btn" style="display:none;width:auto;background:#e5e7eb;color:#111;padding:10px 14px;" data-i18n="sign-out">Sign out</button>
      </div>
    </div>
    <div class="small" style="margin-top:10px;" data-i18n="sync-info">Sign in to sync flashcards across devices.</div>
  </div>

  <!-- Settings -->
  <div id="settingsPanel" class="card hidden">
    <h3 data-i18n="settings-title">âš™ï¸ API Settings</h3>
    <div class="security-info"><span data-i18n="keys-encrypted">ğŸ”’ Your API keys are encrypted before storage.</span></div>

    <div class="api-section">
      <h4 data-i18n="gemini-title">ğŸŒŸ Gemini API (Google)</h4>
      <p class="small" style="margin-bottom:8px;">
        <strong data-i18n="free">FREE:</strong> <span data-i18n="get-key-at">Get key at</span> <a href="https://aistudio.google.com/app/apikey" target="_blank" style="color:#667eea">Google AI Studio</a>
      </p>
      <div class="row" style="margin-bottom:8px;">
        <div class="grow">
          <label data-i18n="model">Model</label>
          <select id="geminiModel" class="input-field" style="height:auto;">
            <option value="gemini-2.5-pro">gemini-2.5-pro</option>
            <option value="gemini-2.5-flash">gemini-2.5-flash</option>
          </select>
        </div>
        <div>
          <label data-i18n="try-alternates">Try alternates</label><br/>
          <input id="geminiTryAlt" type="checkbox" checked style="width:20px;height:20px;">
        </div>
      </div>
      <input type="password" id="geminiKey" class="input-field" data-i18n-placeholder="gemini-key-placeholder" placeholder="Paste Gemini API key" />
      <button class="btn btn-warning" onclick="testApiKey('gemini')" data-i18n="test-btn">ğŸ§ª Test</button>
    </div>

    <div class="api-section">
      <h4 data-i18n="gpt-title">âš¡ OpenAI GPT-4</h4>
      <p class="small" style="margin-bottom:8px;">
        <strong data-i18n="paid">Paid</strong> â€¢ <a href="https://platform.openai.com/api-keys" target="_blank" style="color:#667eea" data-i18n="get-key">Get Key</a>
      </p>
      <input type="password" id="gptKey" class="input-field" data-i18n-placeholder="gpt-key-placeholder" placeholder="Paste OpenAI key" />
      <button class="btn btn-warning" onclick="testApiKey('gpt')" data-i18n="test-btn">ğŸ§ª Test</button>
    </div>

    <div class="api-section">
      <h4 data-i18n="claude-title">ğŸ§  Claude</h4>
      <p class="small" style="margin-bottom:8px;">
        <strong data-i18n="paid">Paid</strong> â€¢ <a href="https://console.anthropic.com/settings/keys" target="_blank" style="color:#667eea" data-i18n="get-key">Get Key</a>
      </p>
      <input type="password" id="claudeKey" class="input-field" data-i18n-placeholder="claude-key-placeholder" placeholder="Paste Claude key" />
      <button class="btn btn-warning" onclick="testApiKey('claude')" data-i18n="test-btn">ğŸ§ª Test</button>
    </div>

    <div style="display:flex;gap:10px;margin-top:20px;">
      <button class="btn btn-primary" onclick="saveAllKeys()" data-i18n="save-btn">ğŸ’¾ Save</button>
      <button class="btn" style="background:#e0e0e0;color:#666" onclick="toggleSettings()" data-i18n="cancel-btn">Cancel</button>
    </div>
  </div>

  <!-- Create Mode -->
  <div id="createMode">
    <div class="card">
      <!-- Input Mode Tabs -->
      <div class="input-mode-tabs">
        <div class="input-tab active" onclick="setInputMode('voice')" data-i18n="voice-tab">ğŸ¤ Voice</div>
        <div class="input-tab" onclick="setInputMode('text')" data-i18n="text-tab">âŒ¨ï¸ Text</div>
      </div>

      <!-- Voice Input -->
      <div id="voiceInput" style="text-align:center;">
        <button id="micButton" class="mic-button" onclick="startListening()">ğŸ¤</button>
        <p id="statusText" style="margin-top:15px;color:#666;font-size:14px;" data-i18n="tap-to-speak">Tap to speak</p>
      </div>

      <!-- Text Input -->
      <div id="textInput" class="text-input-container">
        <textarea id="textArea" data-i18n-placeholder="text-placeholder" placeholder="Type in Persian or English..."></textarea>
        <button class="btn btn-primary" onclick="processText()" style="margin-top:10px;" data-i18n="translate-btn">Translate â†’</button>
      </div>

      <p id="aiStatus" style="margin-top:15px;color:#667eea;font-size:13px;font-weight:600;text-align:center;" data-i18n="using-ai">Using: Gemini (Free)</p>
      <button id="needKeyBtn" class="btn btn-warning hidden" style="margin-top:10px;" onclick="toggleSettings()" data-i18n="add-key-first">âš ï¸ Add API Key First</button>
    </div>

    <div id="resultsCard" class="card hidden">
      <div id="transcriptBox" class="hidden">
        <div class="label" style="color:#667eea;" data-i18n="input-label">INPUT:</div>
        <div class="result-box question" id="transcriptText"></div>
      </div>

      <div id="loadingBox" class="hidden" style="text-align:center;padding:20px;">
        <div class="loading" style="font-size:32px;">â³</div>
        <p style="color:#667eea;" data-i18n="getting-translation">Getting translation...</p>
      </div>

      <div id="errorBox" class="hidden">
        <div class="label" style="color:#ef4444;" data-i18n="error-label">âŒ ERROR:</div>
        <div class="result-box error" id="errorMessage"></div>
        <div class="error-details" id="errorDetails"></div>
        <button class="btn btn-warning" onclick="toggleSettings()" style="margin-top:10px;" data-i18n="check-settings">Check Settings</button>
      </div>

      <div id="translationBox" class="hidden">
        <div class="label" style="color:#10b981;">
          <span data-i18n="english-label">ENGLISH:</span>
          <button class="speak-btn" id="speakTranslationBtn" onclick="speakText(state.translation)" title="Listen to pronunciation">ğŸ”Š</button>
        </div>
        <div class="result-box answer" id="translationText"></div>
        <div class="speech-badge hidden" id="speechSupport">
          <span>ğŸ”Š</span>
          <span data-i18n="pronunciation-available">Click speaker to hear pronunciation</span>
        </div>
        <button class="btn btn-success" onclick="saveFlashcard()" data-i18n="save-flashcard">â• Save as Flashcard</button>
      </div>
    </div>

    <div id="flashcardsList" class="card hidden">
      <h3><span data-i18n="your-flashcards">ğŸ“š Your Flashcards</span> (<span id="listCount">0</span>)</h3>
      <div id="cardsContainer"></div>
    </div>
  </div>

  <!-- Practice Mode -->
  <div id="practiceMode" class="card hidden">
    <div id="practiceProgress" style="text-align:center;color:#667eea;font-weight:bold;margin-bottom:20px;">
      <span data-i18n="card-text">Card</span> <span id="currentCard">1</span> <span data-i18n="of-text">of</span> <span id="totalCards">0</span>
    </div>
    <div class="practice-card">
      <div id="practiceQuestion"></div>
      <div id="practiceAnswer" class="hidden"></div>
    </div>
    <button id="showAnswerBtn" class="btn btn-primary" onclick="showAnswer()" data-i18n="show-answer">Show Answer</button>
    <button id="nextCardBtn" class="btn btn-success hidden" onclick="nextCard()" data-i18n="next-card">âœ“ Next</button>
  </div>
</div>

<button id="settingsBtn" class="settings-btn" onclick="toggleSettings()">âš™ï¸</button>

<script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore-compat.js"></script>

<script>
// Translations
const translations = {
  en: {
    'encrypted': 'ğŸ”’ Encrypted',
    'multi-ai': 'ğŸ¤– Multi-AI',
    'title': 'ğŸ¤ Voice Flashcards',
    'subtitle': 'Works on iOS â€¢ Multi-AI Support â€¢ Text-to-Speech',
    'ai-gemini': 'ğŸŒŸ Gemini 2.x (FREE)',
    'ai-gpt': 'âš¡ GPT-4o (Paid)',
    'ai-claude': 'ğŸ§  Claude Sonnet (Paid)',
    'create-btn': 'âœï¸ Create',
    'practice-btn': 'ğŸ® Practice',
    'ios-warning-title': 'âš ï¸ iOS Voice Input Blocked',
    'ios-warning-text': 'iOS is blocking voice input. Please check:<br>â€¢ Settings â†’ Screen Time â†’ Content Restrictions<br>â€¢ Try Text Input mode instead (below)<br><br>This is an iOS system restriction, not an app bug.',
    'not-signed-in': 'You are not signed in.',
    'sign-in': 'ğŸ”‘ Sign in',
    'sign-out': 'Sign out',
    'sync-info': 'Sign in to sync flashcards across devices.',
    'settings-title': 'âš™ï¸ API Settings',
    'keys-encrypted': 'ğŸ”’ Your API keys are encrypted before storage.',
    'gemini-title': 'ğŸŒŸ Gemini API (Google)',
    'free': 'FREE:',
    'get-key-at': 'Get key at',
    'model': 'Model',
    'try-alternates': 'Try alternates',
    'gemini-key-placeholder': 'Paste Gemini API key',
    'test-btn': 'ğŸ§ª Test',
    'gpt-title': 'âš¡ OpenAI GPT-4',
    'paid': 'Paid',
    'get-key': 'Get Key',
    'gpt-key-placeholder': 'Paste OpenAI key',
    'claude-title': 'ğŸ§  Claude',
    'claude-key-placeholder': 'Paste Claude key',
    'save-btn': 'ğŸ’¾ Save',
    'cancel-btn': 'Cancel',
    'voice-tab': 'ğŸ¤ Voice',
    'text-tab': 'âŒ¨ï¸ Text',
    'tap-to-speak': 'Tap to speak',
    'text-placeholder': 'Type in Persian or English...',
    'translate-btn': 'Translate â†’',
    'using-ai': 'Using: Gemini (Free)',
    'add-key-first': 'âš ï¸ Add API Key First',
    'input-label': 'INPUT:',
    'getting-translation': 'Getting translation...',
    'error-label': 'âŒ ERROR:',
    'check-settings': 'Check Settings',
    'english-label': 'ENGLISH:',
    'save-flashcard': 'â• Save as Flashcard',
    'your-flashcards': 'ğŸ“š Your Flashcards',
    'card-text': 'Card',
    'of-text': 'of',
    'show-answer': 'Show Answer',
    'next-card': 'âœ“ Next',
    'question-label': 'QUESTION:',
    'answer-label': 'ANSWER:',
    'signed-in-as': 'Signed in as',
    'pronunciation-available': 'Click speaker to hear pronunciation',
    'listen-pronunciation': 'Listen'
  },
  fa: {
    'encrypted': 'ğŸ”’ Ø±Ù…Ø²Ù†Ú¯Ø§Ø±ÛŒ Ø´Ø¯Ù‡',
    'multi-ai': 'ğŸ¤– Ú†Ù†Ø¯ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ',
    'title': 'ğŸ¤ ÙÙ„Ø´â€ŒÚ©Ø§Ø±Øªâ€ŒÙ‡Ø§ÛŒ ØµÙˆØªÛŒ',
    'subtitle': 'Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ø¯ Ø¯Ø± iOS â€¢ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø§Ø² Ú†Ù†Ø¯ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ â€¢ ØªØ¨Ø¯ÛŒÙ„ Ù…ØªÙ† Ø¨Ù‡ Ú¯ÙØªØ§Ø±',
    'ai-gemini': 'ğŸŒŸ Gemini 2.x (Ø±Ø§ÛŒÚ¯Ø§Ù†)',
    'ai-gpt': 'âš¡ GPT-4o (Ù¾ÙˆÙ„ÛŒ)',
    'ai-claude': 'ğŸ§  Claude Sonnet (Ù¾ÙˆÙ„ÛŒ)',
    'create-btn': 'âœï¸ Ø³Ø§Ø®Øª',
    'practice-btn': 'ğŸ® ØªÙ…Ø±ÛŒÙ†',
    'ios-warning-title': 'âš ï¸ ÙˆØ±ÙˆØ¯ÛŒ ØµÙˆØªÛŒ iOS Ù…Ø³Ø¯ÙˆØ¯ Ø´Ø¯Ù‡',
    'ios-warning-text': 'iOS ÙˆØ±ÙˆØ¯ÛŒ ØµÙˆØªÛŒ Ø±Ø§ Ù…Ø³Ø¯ÙˆØ¯ Ú©Ø±Ø¯Ù‡. Ù„Ø·ÙØ§Ù‹ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯:<br>â€¢ ØªÙ†Ø¸ÛŒÙ…Ø§Øª â† Ø²Ù…Ø§Ù† ØµÙØ­Ù‡ â† Ù…Ø­Ø¯ÙˆØ¯ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ù…Ø­ØªÙˆØ§<br>â€¢ Ø¨Ù‡ Ø¬Ø§ÛŒ Ø¢Ù† Ø­Ø§Ù„Øª ÙˆØ±ÙˆØ¯ÛŒ Ù…ØªÙ†ÛŒ Ø±Ø§ Ø§Ù…ØªØ­Ø§Ù† Ú©Ù†ÛŒØ¯<br><br>Ø§ÛŒÙ† ÛŒÚ© Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ø³ÛŒØ³ØªÙ… iOS Ø§Ø³ØªØŒ Ù†Ù‡ Ø¨Ø§Ú¯ Ø¨Ø±Ù†Ø§Ù…Ù‡.',
    'not-signed-in': 'Ø´Ù…Ø§ ÙˆØ§Ø±Ø¯ Ù†Ø´Ø¯Ù‡â€ŒØ§ÛŒØ¯.',
    'sign-in': 'ğŸ”‘ ÙˆØ±ÙˆØ¯',
    'sign-out': 'Ø®Ø±ÙˆØ¬',
    'sync-info': 'Ø¨Ø±Ø§ÛŒ Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ ÙÙ„Ø´â€ŒÚ©Ø§Ø±Øªâ€ŒÙ‡Ø§ Ø¯Ø± Ø¯Ø³ØªÚ¯Ø§Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ø®ØªÙ„Ù ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯.',
    'settings-title': 'âš™ï¸ ØªÙ†Ø¸ÛŒÙ…Ø§Øª API',
    'keys-encrypted': 'ğŸ”’ Ú©Ù„ÛŒØ¯Ù‡Ø§ÛŒ API Ø´Ù…Ø§ Ù‚Ø¨Ù„ Ø§Ø² Ø°Ø®ÛŒØ±Ù‡ Ø±Ù…Ø²Ù†Ú¯Ø§Ø±ÛŒ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯.',
    'gemini-title': 'ğŸŒŸ Gemini API (Ú¯ÙˆÚ¯Ù„)',
    'free': 'Ø±Ø§ÛŒÚ¯Ø§Ù†:',
    'get-key-at': 'Ø¯Ø±ÛŒØ§ÙØª Ú©Ù„ÛŒØ¯ Ø§Ø²',
    'model': 'Ù…Ø¯Ù„',
    'try-alternates': 'Ø§Ù…ØªØ­Ø§Ù† Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†â€ŒÙ‡Ø§',
    'gemini-key-placeholder': 'Ú©Ù„ÛŒØ¯ Gemini API Ø±Ø§ Ø¨Ú†Ø³Ø¨Ø§Ù†ÛŒØ¯',
    'test-btn': 'ğŸ§ª ØªØ³Øª',
    'gpt-title': 'âš¡ OpenAI GPT-4',
    'paid': 'Ù¾ÙˆÙ„ÛŒ',
    'get-key': 'Ø¯Ø±ÛŒØ§ÙØª Ú©Ù„ÛŒØ¯',
    'gpt-key-placeholder': 'Ú©Ù„ÛŒØ¯ OpenAI Ø±Ø§ Ø¨Ú†Ø³Ø¨Ø§Ù†ÛŒØ¯',
    'claude-title': 'ğŸ§  Claude',
    'claude-key-placeholder': 'Ú©Ù„ÛŒØ¯ Claude Ø±Ø§ Ø¨Ú†Ø³Ø¨Ø§Ù†ÛŒØ¯',
    'save-btn': 'ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡',
    'cancel-btn': 'Ø§Ù†ØµØ±Ø§Ù',
    'voice-tab': 'ğŸ¤ ØµÙˆØªÛŒ',
    'text-tab': 'âŒ¨ï¸ Ù…ØªÙ†ÛŒ',
    'tap-to-speak': 'Ø¨Ø±Ø§ÛŒ ØµØ­Ø¨Øª Ú©Ø±Ø¯Ù† Ø¶Ø±Ø¨Ù‡ Ø¨Ø²Ù†ÛŒØ¯',
    'text-placeholder': 'Ø¨Ù‡ ÙØ§Ø±Ø³ÛŒ ÛŒØ§ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ ØªØ§ÛŒÙ¾ Ú©Ù†ÛŒØ¯...',
    'translate-btn': 'ØªØ±Ø¬Ù…Ù‡ â†’',
    'using-ai': 'Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø²: Gemini (Ø±Ø§ÛŒÚ¯Ø§Ù†)',
    'add-key-first': 'âš ï¸ Ø§Ø¨ØªØ¯Ø§ Ú©Ù„ÛŒØ¯ API Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯',
    'input-label': 'ÙˆØ±ÙˆØ¯ÛŒ:',
    'getting-translation': 'Ø¯Ø±ÛŒØ§ÙØª ØªØ±Ø¬Ù…Ù‡...',
    'error-label': 'âŒ Ø®Ø·Ø§:',
    'check-settings': 'Ø¨Ø±Ø±Ø³ÛŒ ØªÙ†Ø¸ÛŒÙ…Ø§Øª',
    'english-label': 'Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ:',
    'save-flashcard': 'â• Ø°Ø®ÛŒØ±Ù‡ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† ÙÙ„Ø´â€ŒÚ©Ø§Ø±Øª',
    'your-flashcards': 'ğŸ“š ÙÙ„Ø´â€ŒÚ©Ø§Ø±Øªâ€ŒÙ‡Ø§ÛŒ Ø´Ù…Ø§',
    'card-text': 'Ú©Ø§Ø±Øª',
    'of-text': 'Ø§Ø²',
    'show-answer': 'Ù†Ù…Ø§ÛŒØ´ Ù¾Ø§Ø³Ø®',
    'next-card': 'âœ“ Ø¨Ø¹Ø¯ÛŒ',
    'question-label': 'Ø³ÙˆØ§Ù„:',
    'answer-label': 'Ù¾Ø§Ø³Ø®:',
    'signed-in-as': 'ÙˆØ§Ø±Ø¯ Ø´Ø¯Ù‡ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù†',
    'pronunciation-available': 'Ø±ÙˆÛŒ Ø¨Ù„Ù†Ø¯Ú¯Ùˆ Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯ ØªØ§ ØªÙ„ÙØ¸ Ø±Ø§ Ø¨Ø´Ù†ÙˆÛŒØ¯',
    'listen-pronunciation': 'Ú¯ÙˆØ´ Ø¯Ø§Ø¯Ù†'
  }
};

let currentLang = 'en';
let currentSpeech = null;

// Text-to-Speech Functions
function speakText(text, btnId = null) {
  // Stop any ongoing speech
  if (currentSpeech) {
    window.speechSynthesis.cancel();
    currentSpeech = null;
  }

  // Check if speech synthesis is supported
  if (!('speechSynthesis' in window)) {
    alert(currentLang === 'en' 
      ? 'Text-to-speech is not supported in your browser.' 
      : 'ØªØ¨Ø¯ÛŒÙ„ Ù…ØªÙ† Ø¨Ù‡ Ú¯ÙØªØ§Ø± Ø¯Ø± Ù…Ø±ÙˆØ±Ú¯Ø± Ø´Ù…Ø§ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯.');
    return;
  }

  // Clean the text - remove markdown formatting and HTML
  const cleanText = text
    .replace(/\*\*.*?:\*\*/g, '')  // Remove **Option N:**
    .replace(/^â€¢ /gm, '')           // Remove bullet points
    .replace(/<[^>]*>/g, '')        // Remove HTML tags
    .trim();

  const utterance = new SpeechSynthesisUtterance(cleanText);
  
  // Set language to English
  utterance.lang = 'en-US';
  utterance.rate = 0.9;  // Slightly slower for learning
  utterance.pitch = 1.0;
  
  // Get the button element if ID is provided
  let btn = null;
  if (btnId) {
    btn = document.getElementById(btnId);
  } else {
    btn = document.getElementById('speakTranslationBtn');
  }
  
  // Visual feedback
  if (btn) {
    btn.classList.add('speaking');
  }
  
  utterance.onend = () => {
    if (btn) {
      btn.classList.remove('speaking');
    }
    currentSpeech = null;
  };
  
  utterance.onerror = (event) => {
    console.error('Speech error:', event);
    if (btn) {
      btn.classList.remove('speaking');
    }
    currentSpeech = null;
  };
  
  currentSpeech = utterance;
  window.speechSynthesis.speak(utterance);
}

function stopSpeaking() {
  if (currentSpeech) {
    window.speechSynthesis.cancel();
    currentSpeech = null;
    const btn = document.getElementById('speakTranslationBtn');
    if (btn) {
      btn.classList.remove('speaking');
    }
  }
}

function switchLanguage(lang) {
  currentLang = lang;
  localStorage.setItem('language', lang);
  
  // Update body direction
  document.body.className = lang === 'fa' ? 'rtl' : '';
  
  // Update active button
  const buttons = document.querySelectorAll('.lang-btn');
  buttons.forEach(btn => btn.classList.remove('active'));
  event.target.classList.add('active');
  
  // Apply translations
  applyTranslations();
}

function applyTranslations() {
  const t = translations[currentLang];
  
  // Translate elements with data-i18n attribute
  document.querySelectorAll('[data-i18n]').forEach(el => {
    const key = el.getAttribute('data-i18n');
    if (t[key]) {
      el.innerHTML = t[key];
    }
  });
  
  // Translate placeholders
  document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
    const key = el.getAttribute('data-i18n-placeholder');
    if (t[key]) {
      el.placeholder = t[key];
    }
  });
  
  // Translate select options
  document.querySelectorAll('[data-i18n-opt]').forEach(el => {
    const key = el.getAttribute('data-i18n-opt');
    if (t[key]) {
      el.textContent = t[key];
    }
  });
  
  // Update dynamic content
  updateDynamicTranslations();
}

function updateDynamicTranslations() {
  const t = translations[currentLang];
  const names = {
    gemini: currentLang === 'en' ? 'Gemini (Free)' : 'Gemini (Ø±Ø§ÛŒÚ¯Ø§Ù†)',
    gpt: currentLang === 'en' ? 'GPT-4o (Paid)' : 'GPT-4o (Ù¾ÙˆÙ„ÛŒ)',
    claude: currentLang === 'en' ? 'Claude (Paid)' : 'Claude (Ù¾ÙˆÙ„ÛŒ)'
  };
  
  const aiStatus = document.getElementById('aiStatus');
  if (aiStatus) {
    const prefix = currentLang === 'en' ? 'Using: ' : 'Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø²: ';
    aiStatus.textContent = prefix + names[state.aiProvider];
  }
}

const firebaseConfig={apiKey:"AIzaSyDlPErWZz-vu-mj1H_MwACZ_w_t7CFg4XI",authDomain:"flashcards-2025.firebaseapp.com",projectId:"flashcards-2025",storageBucket:"flashcards-2025.firebasestorage.app",messagingSenderId:"844930689761",appId:"1:844930689761:web:6bc626be70439c5265a5a0"};
firebase.initializeApp(firebaseConfig);
const auth=firebase.auth(),db=firebase.firestore();

function getDeviceFingerprint(){const c=document.createElement('canvas'),x=c.getContext('2d');x.textBaseline='top';x.font='14px Arial';x.fillText('fingerprint',2,2);return c.toDataURL().slice(-50)}
function simpleEncrypt(t,k){let e='';for(let i=0;i<t.length;i++)e+=String.fromCharCode(t.charCodeAt(i)^k.charCodeAt(i%k.length));return btoa(e)}
function simpleDecrypt(e,k){try{const d=atob(e);let r='';for(let i=0;i<d.length;i++)r+=String.fromCharCode(d.charCodeAt(i)^k.charCodeAt(i%k.length));return r}catch{return null}}

let state={mode:'create',inputMode:'voice',flashcards:[],aiProvider:'gemini',apiKeys:{gemini:'',gpt:'',claude:''},transcript:'',translation:'',
currentCardIndex:0,showingAnswer:false,isListening:false,deviceKey:getDeviceFingerprint(),geminiModel:'gemini-2.5-pro',geminiTryAlternates:true};

let recognitionAttempts=0;
const MAX_ATTEMPTS=2;

function loadGeminiPrefs(){const m=localStorage.getItem('geminiModel');const t=localStorage.getItem('geminiTryAlternates');if(m)state.geminiModel=m;if(t!==null)state.geminiTryAlternates=(t==='true');document.getElementById('geminiModel').value=state.geminiModel;document.getElementById('geminiTryAlt').checked=state.geminiTryAlternates}
function saveGeminiPrefs(){state.geminiModel=document.getElementById('geminiModel').value;state.geminiTryAlternates=document.getElementById('geminiTryAlt').checked;localStorage.setItem('geminiModel',state.geminiModel);localStorage.setItem('geminiTryAlternates',state.geminiTryAlternates)}

function loadData(){
  const savedCards=localStorage.getItem('flashcards');const savedProvider=localStorage.getItem('aiProvider');const savedLang=localStorage.getItem('language');
  if(savedLang){currentLang=savedLang;document.body.className=savedLang==='fa'?'rtl':'';document.querySelectorAll('.lang-btn').forEach((btn,i)=>{btn.classList.toggle('active',savedLang===(i===0?'en':'fa'))});}
  if(savedCards){state.flashcards=JSON.parse(savedCards);updateCardCount();renderFlashcards()}
  if(savedProvider){state.aiProvider=savedProvider;document.getElementById('aiProvider').value=savedProvider}
  ['gemini','gpt','claude'].forEach(p=>{const enc=localStorage.getItem(`${p}ApiKey_enc`);if(enc){const dec=simpleDecrypt(enc,state.deviceKey);if(dec){state.apiKeys[p]=dec;const el=document.getElementById(`${p}Key`);if(el)el.value='â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢'+dec.slice(-8)}}});
  loadGeminiPrefs();updateAIProvider();applyTranslations();
  
  // Show speech support badge if available
  if ('speechSynthesis' in window) {
    document.getElementById('speechSupport').classList.remove('hidden');
  }
}

const provider=new firebase.auth.GoogleAuthProvider();
document.getElementById('loginBtn').onclick=()=>auth.signInWithPopup(provider);
document.getElementById('logoutBtn').onclick=()=>auth.signOut();

let cardsRef=null;
auth.onAuthStateChanged(async(user)=>{
  if(user){
    document.getElementById('loginBtn').style.display='none';
    document.getElementById('logoutBtn').style.display='inline-block';
    const prefix = currentLang === 'en' ? 'Signed in as ' : 'ÙˆØ§Ø±Ø¯ Ø´Ø¯Ù‡ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† ';
    document.getElementById('who').innerHTML=`${prefix}<span class="user-pill">${user.displayName||user.email}</span>`;
    cardsRef=db.collection('users').doc(user.uid).collection('flashcards');
    const local=JSON.parse(localStorage.getItem('flashcards')||'[]');
    if(local.length){const batch=db.batch();local.forEach(c=>batch.set(cardsRef.doc(String(c.id)),c));await batch.commit();localStorage.removeItem('flashcards');}
    cardsRef.orderBy('created','desc').onSnapshot(snap=>{state.flashcards=snap.docs.map(d=>d.data());updateCardCount();renderFlashcards();});
  }else{
    document.getElementById('loginBtn').style.display='inline-block';
    document.getElementById('logoutBtn').style.display='none';
    document.getElementById('who').textContent=translations[currentLang]['not-signed-in'];
    const local=JSON.parse(localStorage.getItem('flashcards')||'[]');
    state.flashcards=local;updateCardCount();renderFlashcards();
  }
});

function updateAIProvider(){state.aiProvider=document.getElementById('aiProvider').value;localStorage.setItem('aiProvider',state.aiProvider);updateDynamicTranslations();checkApiKey()}
function checkApiKey(){const btn=document.getElementById('needKeyBtn');btn.classList.toggle('hidden',!!state.apiKeys[state.aiProvider])}
function toggleSettings(){const p=document.getElementById('settingsPanel');const b=document.getElementById('settingsBtn');p.classList.toggle('hidden');b.classList.toggle('hidden');if(!p.classList.contains('hidden'))loadGeminiPrefs();else saveGeminiPrefs()}
function saveAllKeys(){let saved=0;['gemini','gpt','claude'].forEach(p=>{const key=document.getElementById(`${p}Key`).value.trim();if(key&&!key.startsWith('â€¢â€¢â€¢â€¢')){state.apiKeys[p]=key;localStorage.setItem(`${p}ApiKey_enc`,simpleEncrypt(key,state.deviceKey));saved++}});saveGeminiPrefs();const msg=currentLang==='en'?`âœ… Saved ${saved} key(s)!`:`âœ… ${saved} Ú©Ù„ÛŒØ¯ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯!`;alert(saved?msg:(currentLang==='en'?'No new keys.':'Ú©Ù„ÛŒØ¯ Ø¬Ø¯ÛŒØ¯ÛŒ Ù†ÛŒØ³Øª.'));checkApiKey()}

function setInputMode(mode){
  state.inputMode=mode;
  const tabs=document.querySelectorAll('.input-tab');
  tabs[0].classList.toggle('active',mode==='voice');
  tabs[1].classList.toggle('active',mode==='text');
  document.getElementById('voiceInput').style.display=mode==='voice'?'block':'none';
  document.getElementById('textInput').classList.toggle('active',mode==='text');
}

function processText(){
  const text=document.getElementById('textArea').value.trim();
  if(!text){alert(currentLang==='en'?'Please enter some text!':'Ù„Ø·ÙØ§Ù‹ Ù…ØªÙ†ÛŒ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯!');return;}
  if(!state.apiKeys[state.aiProvider]){alert(currentLang==='en'?'Please add API key!':'Ù„Ø·ÙØ§Ù‹ Ú©Ù„ÛŒØ¯ API Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯!');toggleSettings();return;}
  state.transcript=text;
  showTranscript();
  getTranslation(text);
}

async function startListening(){
  if(!state.apiKeys[state.aiProvider]){alert(currentLang==='en'?'Please add API key!':'Ù„Ø·ÙØ§Ù‹ Ú©Ù„ÛŒØ¯ API Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯!');toggleSettings();return;}
  if(!('webkitSpeechRecognition'in window)){alert(currentLang==='en'?"Voice not supported. Try Text mode.":"ØµØ¯Ø§ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯. Ø­Ø§Ù„Øª Ù…ØªÙ†ÛŒ Ø±Ø§ Ø§Ù…ØªØ­Ø§Ù† Ú©Ù†ÛŒØ¯.");setInputMode('text');return;}
  
  recognitionAttempts=0;
  startSpeechRecognition();
}

function startSpeechRecognition(){
  const recognition=new webkitSpeechRecognition();
  recognition.continuous=false;
  recognition.interimResults=false;
  recognition.lang='fa-IR';
  
  let gotResults=false;
  let transcript='';
  
  recognition.onstart=()=>{
    state.isListening=true;
    document.getElementById('micButton').classList.add('listening');
    document.getElementById('micButton').textContent='ğŸ”´';
    document.getElementById('statusText').textContent=currentLang==='en'?'ğŸ¤ Listening...':'ğŸ¤ Ø¯Ø± Ø­Ø§Ù„ Ú¯ÙˆØ´ Ø¯Ø§Ø¯Ù†...';
  };
  
  recognition.onresult=(event)=>{
    gotResults=true;
    transcript=event.results[0][0].transcript;
  };
  
  recognition.onerror=(event)=>{
    if(event.error==='aborted'&&recognitionAttempts<MAX_ATTEMPTS){
      recognitionAttempts++;
      setTimeout(()=>{startSpeechRecognition()},500);
      return;
    }
    
    resetMicButton();
    
    if(event.error==='not-allowed'||event.error==='service-not-allowed'){
      document.getElementById('iosWarning').classList.remove('hidden');
      setTimeout(()=>{setInputMode('text')},2000);
    }else{
      alert(currentLang==='en'?'Voice error. Try Text mode instead.':'Ø®Ø·Ø§ÛŒ ØµÙˆØªÛŒ. Ø­Ø§Ù„Øª Ù…ØªÙ†ÛŒ Ø±Ø§ Ø§Ù…ØªØ­Ø§Ù† Ú©Ù†ÛŒØ¯.');
      setInputMode('text');
    }
  };
  
  recognition.onend=()=>{
    if(gotResults&&transcript.trim()){
      state.transcript=transcript.trim();
      showTranscript();
      getTranslation(state.transcript);
    }else if(!gotResults&&recognitionAttempts===0){
      recognitionAttempts++;
      setTimeout(()=>{startSpeechRecognition()},500);
      return;
    }
    resetMicButton();
  };
  
  try{
    recognition.start();
  }catch(error){
    resetMicButton();
    setInputMode('text');
  }
}

function resetMicButton(){state.isListening=false;document.getElementById('micButton').classList.remove('listening');document.getElementById('micButton').textContent='ğŸ¤';document.getElementById('statusText').textContent=translations[currentLang]['tap-to-speak']}
function showTranscript(){document.getElementById('resultsCard').classList.remove('hidden');document.getElementById('transcriptBox').classList.remove('hidden');document.getElementById('transcriptText').textContent=state.transcript;document.getElementById('errorBox').classList.add('hidden')}

const GEMINI_BASE='https://generativelanguage.googleapis.com';
async function geminiGenerate({model,key,prompt}){const url=`${GEMINI_BASE}/v1beta/models/${model}:generateContent?key=${encodeURIComponent(key)}`;const res=await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({contents:[{parts:[{text:prompt}]}]})});const data=await res.json();return{ok:res.ok,status:res.status,url,data};}
function uniq(a){return[...new Set(a)]}
function modelTryOrder(primary){return uniq([primary,'gemini-2.5-pro','gemini-2.5-flash'])}

async function testApiKey(provider){
  const input=document.getElementById(`${provider}Key`).value.trim();
  const testKey=input.startsWith('â€¢â€¢â€¢â€¢')?state.apiKeys[provider]:input;
  if(!testKey){alert(currentLang==='en'?'Enter key first!':'Ø§Ø¨ØªØ¯Ø§ Ú©Ù„ÛŒØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯!');return;}
  alert(currentLang==='en'?'Testing...':'Ø¯Ø± Ø­Ø§Ù„ ØªØ³Øª...');
  try{
    if(provider==='gemini'){
      saveGeminiPrefs();
      const models=state.geminiTryAlternates?modelTryOrder(state.geminiModel):[state.geminiModel];
      for(const m of models){const r=await geminiGenerate({model:m,key:testKey,prompt:"Say 'Hello'"});if(r.ok&&r.data&&r.data.candidates){alert(`âœ… ${currentLang==='en'?'Works with':'Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ø¯ Ø¨Ø§'} "${m}"\n\n`+r.data.candidates[0].content.parts[0].text);return;}}
      alert(currentLang==='en'?'âŒ Error':'âŒ Ø®Ø·Ø§');
    }else if(provider==='gpt'){
      const r=await fetch('https://api.openai.com/v1/chat/completions',{method:'POST',headers:{'Content-Type':'application/json','Authorization':`Bearer ${testKey}`},body:JSON.stringify({model:'gpt-4o-mini',messages:[{role:'user',content:"Say 'Hello'"}],max_tokens:50})});const d=await r.json();alert(r.ok&&d.choices?(`âœ… ${currentLang==='en'?'Works':'Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ø¯'}\n\n`+d.choices[0].message.content):(`âŒ ${currentLang==='en'?'Error':'Ø®Ø·Ø§'}`));
    }else if(provider==='claude'){
      const r=await fetch('https://api.anthropic.com/v1/messages',{method:'POST',headers:{'Content-Type':'application/json','x-api-key':testKey,'anthropic-version':'2023-06-01'},body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:100,messages:[{role:'user',content:"Say 'Hello'"}]})});const d=await r.json();alert(r.ok&&d.content?(`âœ… ${currentLang==='en'?'Works':'Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ø¯'}\n\n`+d.content[0].text):(`âŒ ${currentLang==='en'?'Error':'Ø®Ø·Ø§'}`));
    }
  }catch(e){alert(`âŒ ${currentLang==='en'?'Error':'Ø®Ø·Ø§'}: `+e.message)}
}

async function getTranslation(text){
  document.getElementById('loadingBox').classList.remove('hidden');document.getElementById('translationBox').classList.add('hidden');document.getElementById('errorBox').classList.add('hidden');
  
  const prompt=`You are a language tutor creating flashcards for language learners.

INPUT: "${text}"

INSTRUCTIONS:
1. Extract the core expression/phrase from the input
2. Provide 2-4 natural English translation options
3. Give practical example sentences for each option
4. Use clean, bulleted formatting that's easy to scan and remember

OUTPUT FORMAT (follow this EXACTLY):

**Option 1:** [Natural English translation]
â€¢ Example: [Short, practical example sentence]

**Option 2:** [Alternative translation]
â€¢ Example: [Short, practical example sentence]

**Option 3:** [Another variation]
â€¢ Example: [Short, practical example sentence]

RULES:
âœ“ Use bullet points (â€¢) for examples
âœ“ Bold option numbers with **Option 1:**, **Option 2:**, etc.
âœ“ Keep examples short (under 12 words)
âœ“ NO grammar explanations
âœ“ NO definitions
âœ“ NO extra commentary
âœ“ Each example on a new line
âœ“ Make it visually clean and scannable

If the input is already English, still provide variations with different formality levels or contexts.`;

  try{
    if(state.aiProvider==='gemini'){
      saveGeminiPrefs();
      const models=state.geminiTryAlternates?modelTryOrder(state.geminiModel):[state.geminiModel];
      for(const m of models){const r=await geminiGenerate({model:m,key:state.apiKeys.gemini,prompt});if(r.ok&&r.data&&r.data.candidates){state.translation=r.data.candidates[0].content.parts[0].text.trim();showTranslation();document.getElementById('loadingBox').classList.add('hidden');return;}}
      showError(currentLang==='en'?'Gemini Error':'Ø®Ø·Ø§ÛŒ Gemini',currentLang==='en'?'Try different model':'Ù…Ø¯Ù„ Ø¯ÛŒÚ¯Ø±ÛŒ Ø±Ø§ Ø§Ù…ØªØ­Ø§Ù† Ú©Ù†ÛŒØ¯');
    }else if(state.aiProvider==='gpt'){
      const r=await fetch('https://api.openai.com/v1/chat/completions',{method:'POST',headers:{'Content-Type':'application/json','Authorization':`Bearer ${state.apiKeys.gpt}`},body:JSON.stringify({model:'gpt-4o-mini',messages:[{role:'user',content:prompt}],max_tokens:300})});const d=await r.json();if(r.ok&&d.choices){state.translation=d.choices[0].message.content.trim();showTranslation()}else showError(currentLang==='en'?'OpenAI Error':'Ø®Ø·Ø§ÛŒ OpenAI',JSON.stringify(d,null,2));
    }else if(state.aiProvider==='claude'){
      const r=await fetch('https://api.anthropic.com/v1/messages',{method:'POST',headers:{'Content-Type':'application/json','x-api-key':state.apiKeys.claude,'anthropic-version':'2023-06-01'},body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:300,messages:[{role:'user',content:prompt}]})});const d=await r.json();if(r.ok&&d.content){state.translation=d.content[0].text.trim();showTranslation()}else showError(currentLang==='en'?'Claude Error':'Ø®Ø·Ø§ÛŒ Claude',JSON.stringify(d,null,2));
    }
  }catch(e){showError(currentLang==='en'?'Network Error':'Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡',e.message)}
  document.getElementById('loadingBox').classList.add('hidden');
}

function showError(message,details){document.getElementById('errorBox').classList.remove('hidden');document.getElementById('translationBox').classList.add('hidden');document.getElementById('errorMessage').textContent=message;document.getElementById('errorDetails').textContent=details}

function formatTranslation(text){
  return text
    .replace(/\*\*Option (\d+):\*\*/g,'<strong style="color:#667eea;font-size:16px;">Option $1:</strong>')
    .replace(/^â€¢ /gm,'<span style="color:#10b981;">â€¢</span> ')
    .replace(/\n/g,'<br>');
}

function showTranslation(){
  document.getElementById('translationBox').classList.remove('hidden');
  document.getElementById('errorBox').classList.add('hidden');
  document.getElementById('translationText').innerHTML=formatTranslation(state.translation);
}

async function saveFlashcard(){
  if(!state.transcript||!state.translation){alert(currentLang==='en'?'Need both!':'Ù‡Ø± Ø¯Ùˆ Ù„Ø§Ø²Ù… Ø§Ø³Øª!');return;}
  const newCard={id:Date.now(),question:state.transcript,answer:state.translation,created:new Date().toISOString(),aiProvider:state.aiProvider,reviewCount:0};
  const user=auth.currentUser;
  if(user){await db.collection('users').doc(user.uid).collection('flashcards').doc(String(newCard.id)).set(newCard);}
  else{state.flashcards.unshift(newCard);localStorage.setItem('flashcards',JSON.stringify(state.flashcards));}
  state.transcript='';state.translation='';
  document.getElementById('textArea').value='';
  document.getElementById('resultsCard').classList.add('hidden');document.getElementById('transcriptBox').classList.add('hidden');document.getElementById('translationBox').classList.add('hidden');
  updateCardCount();renderFlashcards();alert(currentLang==='en'?'Saved! ğŸ‰':'Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯! ğŸ‰');
}

async function deleteCard(id){
  if(!confirm(currentLang==='en'?'Delete?':'Ø­Ø°Ù Ø´ÙˆØ¯?'))return;
  const user=auth.currentUser;
  if(user){await db.collection('users').doc(user.uid).collection('flashcards').doc(String(id)).delete();}
  else{state.flashcards=state.flashcards.filter(c=>c.id!==id);localStorage.setItem('flashcards',JSON.stringify(state.flashcards));}
  updateCardCount();renderFlashcards();
}

function updateCardCount(){document.getElementById('cardCount').textContent=state.flashcards.length;document.getElementById('listCount').textContent=state.flashcards.length;if(state.flashcards.length>0)document.getElementById('flashcardsList').classList.remove('hidden')}
function renderFlashcards(){
  const c=document.getElementById('cardsContainer');c.innerHTML='';
  const aiEmojis={gemini:'ğŸŒŸ',gpt:'âš¡',claude:'ğŸ§ '};
  const qLabel=currentLang==='en'?'Q:':'Ø³:';
  const aLabel=currentLang==='en'?'A:':'Ù¾:';
  const listenText=translations[currentLang]['listen-pronunciation'];
  
  state.flashcards.forEach(card=>{
    const el=document.createElement('div');
    el.className='flashcard-item';
    el.innerHTML=`
      <div style="font-size:11px;color:#999;margin-bottom:4px;">${aiEmojis[card.aiProvider]||'ğŸ¤–'} ${card.aiProvider}</div>
      <div style="font-size:14px;color:#666;margin-bottom:8px;"><strong>${qLabel}</strong> ${card.question}</div>
      <div style="font-size:14px;color:#10b981;line-height:1.7;">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">
          <strong>${aLabel}</strong>
          <button class="speak-btn" onclick="speakText(\`${card.answer.replace(/`/g, '\\`').replace(/\$/g, '\\$')}\`)" title="${listenText}" style="width:24px;height:24px;font-size:12px;">ğŸ”Š</button>
        </div>
        ${formatTranslation(card.answer)}
      </div>
      <button class="delete-btn" onclick="deleteCard(${card.id})">ğŸ—‘ï¸</button>
    `;
    c.appendChild(el);
  });
}

function setMode(mode){
  state.mode=mode;
  const btns=document.querySelectorAll('.mode-btn');
  btns[0].className=mode==='create'?'mode-btn active':'mode-btn inactive';
  btns[1].className=mode==='practice'?'mode-btn active':'mode-btn inactive';
  document.getElementById('createMode').classList.toggle('hidden',mode!=='create');
  document.getElementById('practiceMode').classList.toggle('hidden',mode!=='practice');
  if(mode==='practice'){
    if(state.flashcards.length===0){alert(currentLang==='en'?'Create cards first!':'Ø§Ø¨ØªØ¯Ø§ Ú©Ø§Ø±Øª Ø¨Ø³Ø§Ø²ÛŒØ¯!');setMode('create');return;}
    startPractice();
  }
}

function startPractice(){state.currentCardIndex=0;state.showingAnswer=false;showPracticeCard()}

function showPracticeCard(){
  const card=state.flashcards[state.currentCardIndex];
  document.getElementById('currentCard').textContent=state.currentCardIndex+1;
  document.getElementById('totalCards').textContent=state.flashcards.length;
  const qLabel=currentLang==='en'?'QUESTION:':'Ø³ÙˆØ§Ù„:';
  const aLabel=currentLang==='en'?'ANSWER:':'Ù¾Ø§Ø³Ø®:';
  const listenText=translations[currentLang]['listen-pronunciation'];
  
  document.getElementById('practiceQuestion').innerHTML=`<div style="color:#667eea;font-size:14px;margin-bottom:10px;font-weight:bold;">${qLabel}</div><div style="font-size:16px;">${card.question}</div>`;
  document.getElementById('practiceAnswer').innerHTML=`
    <div style="color:#10b981;font-size:14px;margin-bottom:10px;font-weight:bold;display:flex;align-items:center;gap:8px;">
      <span>${aLabel}</span>
      <button class="speak-btn" onclick="speakText(\`${card.answer.replace(/`/g, '\\`').replace(/\$/g, '\\$')}\`, 'practiceAnswerSpeakBtn')" id="practiceAnswerSpeakBtn" title="${listenText}">ğŸ”Š</button>
    </div>
    <div style="font-size:15px;line-height:1.8;">${formatTranslation(card.answer)}</div>
  `;
  document.getElementById('practiceQuestion').classList.remove('hidden');
  document.getElementById('practiceAnswer').classList.add('hidden');
  document.getElementById('showAnswerBtn').classList.remove('hidden');
  document.getElementById('nextCardBtn').classList.add('hidden');
}

function showAnswer(){
  document.getElementById('practiceAnswer').classList.remove('hidden');
  document.getElementById('showAnswerBtn').classList.add('hidden');
  document.getElementById('nextCardBtn').classList.remove('hidden');
}

function nextCard(){
  state.flashcards[state.currentCardIndex].reviewCount+=1;
  const user=auth.currentUser;
  if(user){
    db.collection('users').doc(user.uid).collection('flashcards').doc(String(state.flashcards[state.currentCardIndex].id)).update({reviewCount:firebase.firestore.FieldValue.increment(1)}).catch(()=>{})
  }else{
    localStorage.setItem('flashcards',JSON.stringify(state.flashcards))
  }
  
  // Stop any ongoing speech when moving to next card
  stopSpeaking();
  
  if(state.currentCardIndex<state.flashcards.length-1){
    state.currentCardIndex++;
    showPracticeCard();
  }else{
    alert(currentLang==='en'?'ğŸ‰ Done!':'ğŸ‰ ØªÙ…Ø§Ù…!');
    setMode('create');
  }
}

window.onload=loadData;
document.addEventListener('change',(e)=>{if(e.target&&(e.target.id==='geminiModel'||e.target.id==='geminiTryAlt'))saveGeminiPrefs()});
</script>
</body>
</html>
