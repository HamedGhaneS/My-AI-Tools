<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="theme-color" content="#667eea" />
<title>🎤 Roham's English Learning</title>

<link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIlJvaGFtJ3MgRW5nbGlzaCBMZWFybmluZyIsCiAgInNob3J0X25hbWUiOiAiUm9oYW0ncyBFbmdsaXNoIiwKICAic3RhcnRfdXJsIjogIi4iLAogICJkaXNwbGF5IjogInN0YW5kYWxvbmUiLAogICJiYWNrZ3JvdW5kX2NvbG9yIjogIiM2NjdlZWEiLAogICJ0aGVtZV9jb2xvciI6ICIjNjY3ZWVhIiwKICAiaWNvbnMiOiBbeyJzcmMiOiAiZGF0YTppbWFnZS9zdmcreG1sLCUzQ3N2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHZpZXdCb3g9JzAgMCAxMDAgMTAwJyUzRSUzQ3RleHQgeT0nLjllbScgZm9udC1zaXplPSc5MCclM0UlRjAlOUYlOEUlQTQlM0MvdGV4dCUzRSUzQy9zdmclM0UiLCAic2l6ZXMiOiAiMTkyeDE5MiIsICJ0eXBlIjogImltYWdlL3N2Zyt4bWwiIH1dCn0=" />

<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:20px 20px 100px}
body.rtl{direction:rtl}
.container{max-width:600px;margin:0 auto}
.card{background:#fff;border-radius:20px;padding:20px;margin-bottom:20px;box-shadow:0 10px 30px rgba(0,0,0,.2);position:relative}

.roham-character{position:absolute;top:-60px;right:20px;width:100px;height:100px;border-radius:50%;overflow:hidden;border:4px solid #fff;box-shadow:0 4px 15px rgba(0,0,0,0.2);z-index:10;background:#e0f2fe}
body.rtl .roham-character{right:auto;left:20px}
.roham-character img{width:100%;height:100%;object-fit:cover}

.hero-video-container{position:relative;width:100%;max-width:350px;margin:0 auto 20px;border-radius:15px;overflow:hidden;box-shadow:0 8px 25px rgba(0,0,0,0.3);background:#000}
.hero-video{width:100%;height:auto;display:block}
.hero-video-overlay{position:absolute;top:0;left:0;right:0;bottom:0;background:linear-gradient(to bottom,transparent 60%,rgba(0,0,0,0.2) 100%);pointer-events:none}

.hero-card{background:linear-gradient(135deg,#fbbf24 0%,#f59e0b 100%);color:#fff;padding:80px 20px 30px;text-align:center;border-radius:25px;box-shadow:0 15px 40px rgba(0,0,0,0.3);margin-bottom:25px;overflow:hidden}
.hero-title{font-size:32px;font-weight:900;margin-bottom:10px;text-shadow:2px 2px 4px rgba(0,0,0,0.2)}
.hero-subtitle{font-size:16px;opacity:0.95;font-weight:600}

.translation-direction{background:linear-gradient(135deg,#e0f2fe,#bae6fd);border:3px solid #0284c7;border-radius:15px;padding:15px;margin:20px 0;display:flex;gap:10px;align-items:center;justify-content:center}
.direction-btn{flex:1;padding:12px;border:2px solid #0284c7;border-radius:10px;background:#fff;cursor:pointer;text-align:center;font-weight:700;font-size:14px;transition:all 0.3s}
.direction-btn.active{background:#0284c7;color:#fff;border-color:#0284c7;transform:scale(1.05)}
.direction-btn:hover:not(.active){background:#f0f9ff}

.api-tutorial{background:linear-gradient(135deg,#fef3c7,#fde68a);border:4px solid #f59e0b;border-radius:20px;padding:20px;margin:20px 0;cursor:pointer;transition:all 0.3s;box-shadow:0 8px 20px rgba(245,158,11,0.3)}
.api-tutorial:hover{transform:translateY(-2px);box-shadow:0 12px 25px rgba(245,158,11,0.4)}
.api-tutorial-header{display:flex;align-items:center;justify-content:space-between;gap:15px}
.api-tutorial-title{color:#78350f;font-size:20px;font-weight:800;display:flex;align-items:center;gap:10px}
.api-tutorial-toggle{background:#fff;color:#f59e0b;width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:24px;font-weight:bold;transition:transform 0.3s;box-shadow:0 2px 8px rgba(0,0,0,0.1)}
.api-tutorial.expanded .api-tutorial-toggle{transform:rotate(180deg)}
.api-tutorial-content{max-height:0;overflow:hidden;transition:max-height 0.5s ease-out;margin-top:0}
.api-tutorial.expanded .api-tutorial-content{max-height:2000px;margin-top:20px}
.api-step{background:#fff;border-radius:12px;padding:18px;margin-bottom:15px;box-shadow:0 2px 8px rgba(0,0,0,0.1);display:flex;gap:15px;align-items:flex-start}
.api-step-number{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:20px;flex-shrink:0}
.api-step-text{flex:1;color:#451a03;line-height:1.7}
.api-step-text strong{color:#1e40af;display:block;margin-bottom:8px;font-size:16px}

.instruction-box{background:linear-gradient(135deg,#dbeafe,#bfdbfe);border:3px solid #3b82f6;border-radius:15px;padding:20px;margin:20px 0;line-height:1.9}
.instruction-box h3{color:#1e40af;margin-bottom:15px;font-size:18px;display:flex;align-items:center;gap:10px}
.instruction-text{color:#1e3a8a;font-size:15px;font-weight:500}

.examples-box{background:linear-gradient(135deg,#fef3c7,#fde68a);border:3px solid #f59e0b;border-radius:15px;padding:20px;margin:20px 0}
.examples-box h3{color:#78350f;margin-bottom:15px;font-size:18px;display:flex;align-items:center;gap:10px}
.example-item{background:#fff;border-radius:10px;padding:15px;margin-bottom:12px;border-left:4px solid #f59e0b;box-shadow:0 2px 8px rgba(0,0,0,0.1)}
body.rtl .example-item{border-left:none;border-right:4px solid #f59e0b}
.example-step{font-weight:700;color:#92400e;margin-bottom:8px;font-size:14px}
.example-content{color:#451a03;line-height:1.7;font-size:14px}

.lang-switcher{position:fixed;top:20px;right:20px;z-index:1000;background:#fff;border-radius:12px;padding:8px;box-shadow:0 4px 12px rgba(0,0,0,.2);display:flex;gap:5px}
body.rtl .lang-switcher{right:auto;left:20px}
.lang-btn{padding:8px 16px;border:none;border-radius:8px;font-weight:700;font-size:14px;cursor:pointer;background:#f3f4f6;color:#666;transition:all 0.3s}
.lang-btn.active{background:#667eea;color:#fff}
.security-badge{display:inline-flex;align-items:center;gap:6px;background:linear-gradient(135deg,#10b981,#059669);color:#fff;padding:8px 16px;border-radius:20px;font-size:13px;font-weight:600;margin-bottom:16px}
.ai-badge{display:inline-flex;align-items:center;gap:6px;background:linear-gradient(135deg,#8b5cf6,#6366f1);color:#fff;padding:8px 16px;border-radius:20px;font-size:13px;font-weight:600;margin-left:8px}
body.rtl .ai-badge{margin-left:0;margin-right:8px}
h1{color:#667eea;margin-bottom:10px}.subtitle{color:#666;font-size:14px}
.ai-selector{margin:16px 0;padding:12px;background:#f3f4f6;border-radius:12px}
.ai-selector select{width:100%;padding:12px;border:2px solid #667eea;border-radius:10px;font-size:16px;font-weight:600;color:#667eea;background:#fff;cursor:pointer}
.input-mode-tabs{display:flex;gap:10px;margin:16px 0}
.input-tab{flex:1;padding:12px;border:2px solid #e0e0e0;border-radius:10px;background:#fff;cursor:pointer;text-align:center;font-weight:600;font-size:14px;transition:all 0.3s}
.input-tab.active{background:#667eea;color:#fff;border-color:#667eea}
.mode-selector{display:flex;gap:10px;margin-top:15px}
.mode-btn{flex:1;padding:12px;border:none;border-radius:10px;font-weight:700;cursor:pointer;font-size:14px}
.mode-btn.active{background:#667eea;color:#fff}.mode-btn.inactive{background:#e0e0e0;color:#666}
.mic-button{width:120px;height:120px;border-radius:50%;border:none;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;font-size:48px;cursor:pointer;display:flex;align-items:center;justify-content:center;margin:0 auto;transition:.3s;box-shadow:0 8px 20px rgba(102,126,234,.4)}
.mic-button:disabled{opacity:.6;cursor:not-allowed}.mic-button.listening{background:linear-gradient(135deg,#ef4444,#dc2626);animation:pulse 1.5s infinite}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
.text-input-container{display:none}
.text-input-container.active{display:block}
.text-input-container textarea{width:100%;min-height:100px;padding:15px;border:2px solid #667eea;border-radius:10px;font-size:16px;font-family:inherit;resize:vertical}
.result-box{padding:12px;border-radius:10px;margin-bottom:15px;white-space:pre-wrap;line-height:1.8;position:relative}
.result-box.question{background:#f3f4f6}.result-box.answer{background:#d1fae5;font-size:15px}.result-box.error{background:#fee2e2;border:2px solid #ef4444}
.label{font-size:12px;font-weight:700;margin-bottom:5px;display:flex;align-items:center;gap:8px}
.speak-btn{background:#667eea;color:#fff;border:none;border-radius:50%;width:32px;height:32px;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;font-size:16px;transition:all 0.3s;box-shadow:0 2px 8px rgba(102,126,234,0.3)}
.speak-btn:hover{background:#5568d3;transform:scale(1.05)}
.speak-btn:active{transform:scale(0.95)}
.speak-btn.playing{background:#ef4444}
.speak-btn.playing:hover{background:#dc2626}
.btn{width:100%;padding:15px;border:none;border-radius:10px;font-weight:700;font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px}
.btn-primary{background:#667eea;color:#fff}.btn-success{background:#10b981;color:#fff}.btn-warning{background:#fbbf24;color:#92400e}
.api-section{margin:20px 0;padding:16px;background:#f9fafb;border-radius:12px;border-left:4px solid #667eea}
body.rtl .api-section{border-left:none;border-right:4px solid #667eea}
.api-section h4{color:#667eea;margin-bottom:8px}
.flashcard-item{padding:18px;background:#f9fafb;border-radius:10px;margin-bottom:10px;position:relative;padding-right:50px;line-height:1.7}
body.rtl .flashcard-item{padding-right:18px;padding-left:50px}
.delete-btn{position:absolute;top:10px;right:10px;background:#ef4444;color:#fff;border:none;border-radius:50%;width:30px;height:30px;cursor:pointer;font-size:18px}
body.rtl .delete-btn{right:auto;left:10px}
.settings-btn{position:fixed;bottom:20px;right:20px;width:60px;height:60px;border-radius:50%;background:#fff;border:none;box-shadow:0 4px 12px rgba(0,0,0,.3);cursor:pointer;font-size:24px}
body.rtl .settings-btn{right:auto;left:20px}
.input-field{width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:10px;font-size:14px;margin:10px 0}
.practice-card{min-height:150px;display:flex;align-items:center;justify-content:center;background:#f9fafb;border-radius:15px;padding:30px;margin:20px 0;font-size:20px;line-height:1.6;text-align:center}
.security-info{background:#f0f9ff;border-left:4px solid #3b82f6;padding:12px;margin:16px 0;border-radius:8px;font-size:13px;color:#1e40af}
body.rtl .security-info{border-left:none;border-right:4px solid #3b82f6}
.error-details{background:#fee2e2;border-left:4px solid #ef4444;padding:12px;margin:16px 0;border-radius:8px;font-size:12px;color:#991b1b;font-family:monospace;max-height:200px;overflow-y:auto;white-space:pre-wrap}
body.rtl .error-details{border-left:none;border-right:4px solid #ef4444}
.hidden{display:none}@keyframes spin{from{transform:rotate(0)}to{transform:rotate(360deg)}}.loading{animation:spin 1s linear infinite}
.row{display:flex;gap:10px;align-items:center}.grow{flex:1}.small{font-size:12px;color:#666}label{font-size:12px;color:#555;font-weight:600}
.auth-row{display:flex;gap:10px;align-items:center;justify-content:space-between}
.user-pill{background:#eef2ff;color:#4f46e5;border:1px solid:#c7d2fe;border-radius:999px;padding:6px 12px;font-size:12px;font-weight:700}
.ios-warning{background:#fef3c7;border-left:4px solid #f59e0b;padding:12px;margin:16px 0;border-radius:8px;font-size:13px;color:#78350f;line-height:1.5}
body.rtl .ios-warning{border-left:none;border-right:4px solid #f59e0b}
.speech-badge{background:#eef2ff;border:1px solid #c7d2fe;border-radius:8px;padding:8px 12px;font-size:12px;color:#4f46e5;margin-top:10px;display:inline-flex;align-items:center;gap:6px}

@media (max-width: 480px) {
  .hero-video-container{max-width:280px}
  .hero-title{font-size:26px}
  .hero-subtitle{font-size:14px}
}
</style>
</head>
<body>

<div class="lang-switcher">
  <button class="lang-btn active" onclick="switchLanguage('en')">EN</button>
  <button class="lang-btn" onclick="switchLanguage('fa')">فا</button>
</div>

<div class="container">
  <div class="hero-card">
    <div class="roham-character">
      <img src="https://i.postimg.cc/qR5g8Nhh/animated-boy.jpg" alt="Roham">
    </div>
    
    <div class="hero-video-container">
      <video class="hero-video" autoplay loop muted playsinline>
        <source src="roham-video.mp4" type="video/mp4">
        <source src="roham-video.webm" type="video/webm">
      </video>
      <div class="hero-video-overlay"></div>
    </div>
    
    <h1 class="hero-title" data-i18n="main-title">🎤 Roham's English Learning</h1>
    <p class="hero-subtitle" data-i18n="main-subtitle">Learn English with AI • Create Flashcards • Practice Anytime!</p>
  </div>

  <div class="api-tutorial" id="apiTutorial" onclick="toggleTutorial()">
    <div class="api-tutorial-header">
      <div class="api-tutorial-title">
        <span>🔑</span>
        <span>چطور کلید API رایگان بگیرم؟ (کلیک کنید)</span>
      </div>
      <div class="api-tutorial-toggle">▼</div>
    </div>
    
    <div class="api-tutorial-content">
      <div style="background:#fef3c7;padding:12px;border-radius:8px;margin-bottom:15px;border:2px solid #f59e0b;">
        <strong>⚠️ مهم:</strong> برای استفاده از این برنامه، فقط یک بار نیاز دارید یک کلید رایگان دریافت کنید. کاملاً رایگان است و فقط ۵ دقیقه وقت می‌برد!
      </div>

      <div class="api-step">
        <div class="api-step-number">۱</div>
        <div class="api-step-text">
          <strong>به سایت گوگل بروید:</strong>
          روی این لینک کلیک کنید: <a href="https://aistudio.google.com/app/apikey" target="_blank" style="color:#667eea;font-weight:bold;">Google AI Studio</a><br>
          <small style="color:#666;">یا این آدرس را در مرورگر باز کنید: aistudio.google.com/app/apikey</small>
        </div>
      </div>

      <div class="api-step">
        <div class="api-step-number">۲</div>
        <div class="api-step-text">
          <strong>وارد حساب گوگل خود شوید:</strong>
          اگر از قبل وارد Gmail نشده‌اید، از شما می‌خواهد که با حساب گوگلتان وارد شوید.<br>
          <small style="color:#10b981;">✓ همان حساب Gmail معمولی‌تان را استفاده کنید</small>
        </div>
      </div>

      <div class="api-step">
        <div class="api-step-number">۳</div>
        <div class="api-step-text">
          <strong>دکمه "Create API Key" را بزنید:</strong>
          در صفحه، یک دکمه آبی رنگ با عنوان "Create API key" یا "Get API key" خواهید دید. روی آن کلیک کنید.
        </div>
      </div>

      <div class="api-step">
        <div class="api-step-number">۴</div>
        <div class="api-step-text">
          <strong>یک پروژه انتخاب کنید:</strong>
          اگر اولین بار است، گزینه "Create new project" را انتخاب کنید. یک اسم دلخواه بهش بدید (مثلاً "English Learning")
        </div>
      </div>

      <div class="api-step">
        <div class="api-step-number">۵</div>
        <div class="api-step-text">
          <strong>کلید را کپی کنید:</strong>
          یک متن بلند که با "AIza" شروع می‌شود نمایش داده می‌شود. روی دکمه کپی (📋) کنارش کلیک کنید تا کپی شود.<br>
          <small style="color:#ef4444;">⚠️ این کلید را با کسی به اشتراک نگذارید!</small>
        </div>
      </div>

      <div class="api-step">
        <div class="api-step-number">۶</div>
        <div class="api-step-text">
          <strong>کلید را در برنامه وارد کنید:</strong>
          • روی دکمه تنظیمات (⚙️) پایین صفحه کلیک کنید<br>
          • در قسمت "Gemini API"، کلید را در کادر Paste کنید<br>
          • روی دکمه "🧪 Test" بزنید تا مطمئن شوید کار می‌کند<br>
          • بعد روی "💾 Save" کلیک کنید
        </div>
      </div>

      <div style="background:#d1fae5;padding:15px;border-radius:10px;margin-top:20px;border:2px solid #10b981;">
        <strong style="color:#065f46;">🎉 تمام! حالا می‌تونید استفاده کنید</strong><br>
        <small>این کلید تا ابد رایگان است و روزی ۱۵۰۰ بار می‌تونید ازش استفاده کنید!</small>
      </div>

      <button class="btn btn-primary" onclick="event.stopPropagation(); toggleSettings();" style="margin-top:15px;">
        ✅ متوجه شدم، بریم تنظیمات!
      </button>
    </div>
  </div>

  <div class="instruction-box" id="instructionBox">
    <h3>
      <span>📚</span>
      <span data-i18n="instruction-title">چطور کار می‌کنه؟</span>
    </h3>
    <div class="instruction-text" data-i18n="instruction-text">
      اینجا میتونید هر کلمه، عبارت یا جمله‌ای که دوست دارین رو به فارسی یا انگلیسی بگین تا هوش مصنوعی براتون ترجمه‌ش رو بگه و بعد هم میتونید اون رو ذخیره کنین به صورت فلش‌کارت برای مرور و یادگیری بعدی!
    </div>
  </div>

  <div class="examples-box" id="examplesBox">
    <h3>
      <span>💡</span>
      <span data-i18n="examples-title">مثال‌های استفاده</span>
    </h3>
    
    <div class="example-item">
      <div class="example-step" data-i18n="example1-title">🎤 مثال ۱: فارسی به انگلیسی - گفتن یک کلمه</div>
      <div class="example-content" data-i18n="example1-content">
        <strong>چی بگم:</strong> "دانشگاه"<br>
        <strong>نتیجه:</strong> هوش مصنوعی چند ترجمه انگلیسی مثل "University" و "College" بهت میده با مثال‌هاشون
      </div>
    </div>

    <div class="example-item">
      <div class="example-step" data-i18n="example2-title">✏️ مثال ۲: فارسی به انگلیسی - نوشتن یک عبارت</div>
      <div class="example-content" data-i18n="example2-content">
        <strong>چی بنویسم:</strong> "من امروز خیلی خوشحالم"<br>
        <strong>نتیجه:</strong> ترجمه‌های انگلیسی مثل "I'm very happy today" یا "I'm really joyful today" با مثال‌های کاربردی
      </div>
    </div>

    <div class="example-item">
      <div class="example-step" data-i18n="example3-title">🎤 مثال ۳: انگلیسی به فارسی - گفتن یک کلمه</div>
      <div class="example-content" data-i18n="example3-content">
        <strong>چی بگم:</strong> "Happy"<br>
        <strong>نتیجه:</strong> هوش مصنوعی چند ترجمه فارسی مثل "خوشحال"، "شاد"، "خرسند" بهت میده با مثال‌هاشون
      </div>
    </div>

    <div class="example-item">
      <div class="example-step" data-i18n="example4-title">✏️ مثال ۴: انگلیسی به فارسی - نوشتن یک جمله</div>
      <div class="example-content" data-i18n="example4-content">
        <strong>چی بنویسم:</strong> "I love learning new things"<br>
        <strong>نتیجه:</strong> ترجمه‌های فارسی مثل "من عاشق یادگیری چیزهای جدید هستم" با توضیحات کاربردی
      </div>
    </div>

    <div class="example-item">
      <div class="example-step" data-i18n="example5-title">💾 مثال ۵: ذخیره و تمرین</div>
      <div class="example-content" data-i18n="example5-content">
        بعد از اینکه ترجمه رو دیدی، روی دکمه "ذخیره به عنوان فلش‌کارت" بزن. بعد می‌تونی از قسمت "تمرین" کارت‌هات رو مرور کنی و یاد بگیری! 🎮
      </div>
    </div>

          <div class="example-item">
      <div class="example-step" data-i18n="example6-title">🔊 مثال ۶: گوش دادن به تلفظ</div>
      <div class="example-content" data-i18n="example6-content">
        روی آیکون بلندگو 🔊 کلیک کن تا تلفظ صحیح رو بشنوی و یاد بگیری!
      </div>
    </div>
  </div>

  <div class="card">
    <div>
      <span class="security-badge" data-i18n="encrypted">🔒 Encrypted</span>
      <span class="ai-badge" data-i18n="multi-ai">🤖 Multi-AI</span>
    </div>

    <div class="translation-direction">
      <button class="direction-btn active" id="dirFaEn" onclick="setTranslationDirection('fa-en')">
        <span data-i18n="fa-to-en">فارسی → English</span>
      </button>
      <button class="direction-btn" id="dirEnFa" onclick="setTranslationDirection('en-fa')">
        <span data-i18n="en-to-fa">English → فارسی</span>
      </button>
    </div>

    <div class="ai-selector">
      <select id="aiProvider" onchange="updateAIProvider()">
        <option value="gemini" data-i18n-opt="ai-gemini">🌟 Gemini 2.x (FREE)</option>
        <option value="gpt" data-i18n-opt="ai-gpt">⚡ GPT-4o (Paid)</option>
        <option value="claude" data-i18n-opt="ai-claude">🧠 Claude Sonnet (Paid)</option>
      </select>
    </div>

    <div class="mode-selector">
      <button class="mode-btn active" onclick="setMode('create')"><span data-i18n="create-btn">✏️ Create</span></button>
      <button class="mode-btn inactive" onclick="setMode('practice')"><span data-i18n="practice-btn">🎮 Practice</span> (<span id="cardCount">0</span>)</button>
    </div>
  </div>

  <div id="iosWarning" class="card ios-warning hidden">
    <strong data-i18n="ios-warning-title">⚠️ iOS Voice Input Blocked</strong><br><br>
    <span data-i18n="ios-warning-text">iOS is blocking voice input. Please check:<br>• Settings → Screen Time → Content Restrictions<br>• Try Text Input mode instead (below)<br><br>This is an iOS system restriction, not an app bug.</span>
  </div>

  <div id="authCard" class="card">
    <div class="auth-row">
      <div id="who" class="small" style="color:#667eea" data-i18n="not-signed-in">You are not signed in.</div>
      <div>
        <button id="loginBtn" class="btn btn-primary" style="width:auto;padding:10px 14px;" data-i18n="sign-in">🔑 Sign in</button>
        <button id="logoutBtn" class="btn" style="display:none;width:auto;background:#e5e7eb;color:#111;padding:10px 14px;" data-i18n="sign-out">Sign out</button>
      </div>
    </div>
    <div class="small" style="margin-top:10px;" data-i18n="sync-info">Sign in to sync flashcards across devices.</div>
  </div>

  <div id="settingsPanel" class="card hidden">
    <h3 data-i18n="settings-title">⚙️ API Settings</h3>
    <div class="security-info"><span data-i18n="keys-encrypted">🔒 Your API keys are encrypted before storage.</span></div>

    <div class="api-section">
      <h4 data-i18n="gemini-title">🌟 Gemini API (Google)</h4>
      <p class="small" style="margin-bottom:8px;">
        <strong data-i18n="free">FREE:</strong> <span data-i18n="get-key-at">Get key at</span> <a href="https://aistudio.google.com/app/apikey" target="_blank" style="color:#667eea">Google AI Studio</a>
      </p>
      <div class="row" style="margin-bottom:8px;">
        <div class="grow">
          <label data-i18n="model">Model</label>
          <select id="geminiModel" class="input-field" style="height:auto;">
            <option value="gemini-2.0-flash-exp">gemini-2.0-flash-exp</option>
            <option value="gemini-1.5-flash">gemini-1.5-flash</option>
            <option value="gemini-1.5-pro">gemini-1.5-pro</option>
          </select>
        </div>
        <div>
          <label data-i18n="try-alternates">Try alternates</label><br/>
          <input id="geminiTryAlt" type="checkbox" checked style="width:20px;height:20px;">
        </div>
      </div>
      <input type="password" id="geminiKey" class="input-field" data-i18n-placeholder="gemini-key-placeholder" placeholder="Paste Gemini API key" />
      <button class="btn btn-warning" onclick="testApiKey('gemini')" data-i18n="test-btn">🧪 Test</button>
    </div>

    <div class="api-section">
      <h4 data-i18n="gpt-title">⚡ OpenAI GPT-4</h4>
      <p class="small" style="margin-bottom:8px;">
        <strong data-i18n="paid">Paid</strong> • <a href="https://platform.openai.com/api-keys" target="_blank" style="color:#667eea" data-i18n="get-key">Get Key</a>
      </p>
      <input type="password" id="gptKey" class="input-field" data-i18n-placeholder="gpt-key-placeholder" placeholder="Paste OpenAI key" />
      <button class="btn btn-warning" onclick="testApiKey('gpt')" data-i18n="test-btn">🧪 Test</button>
    </div>

    <div class="api-section">
      <h4 data-i18n="claude-title">🧠 Claude</h4>
      <p class="small" style="margin-bottom:8px;">
        <strong data-i18n="paid">Paid</strong> • <a href="https://console.anthropic.com/settings/keys" target="_blank" style="color:#667eea" data-i18n="get-key">Get Key</a>
      </p>
      <input type="password" id="claudeKey" class="input-field" data-i18n-placeholder="claude-key-placeholder" placeholder="Paste Claude key" />
      <button class="btn btn-warning" onclick="testApiKey('claude')" data-i18n="test-btn">🧪 Test</button>
    </div>

    <div style="display:flex;gap:10px;margin-top:20px;">
      <button class="btn btn-primary" onclick="saveAllKeys()" data-i18n="save-btn">💾 Save</button>
      <button class="btn" style="background:#e0e0e0;color:#666" onclick="toggleSettings()" data-i18n="cancel-btn">Cancel</button>
    </div>
  </div>

  <div id="createMode">
    <div class="card">
      <div class="input-mode-tabs">
        <div class="input-tab active" onclick="setInputMode('voice')" data-i18n="voice-tab">🎤 Voice</div>
        <div class="input-tab" onclick="setInputMode('text')" data-i18n="text-tab">⌨️ Text</div>
      </div>

      <div id="voiceInput" style="text-align:center;">
        <button id="micButton" class="mic-button" onclick="startListening()">🎤</button>
        <p id="statusText" style="margin-top:15px;color:#666;font-size:14px;" data-i18n="tap-to-speak">Tap to speak</p>
      </div>

      <div id="textInput" class="text-input-container">
        <textarea id="textArea" data-i18n-placeholder="text-placeholder" placeholder="Type in Persian or English..."></textarea>
        <button class="btn btn-primary" onclick="processText()" style="margin-top:10px;" data-i18n="translate-btn">Translate →</button>
      </div>

      <p id="aiStatus" style="margin-top:15px;color:#667eea;font-size:13px;font-weight:600;text-align:center;" data-i18n="using-ai">Using: Gemini (Free)</p>
      <button id="needKeyBtn" class="btn btn-warning hidden" style="margin-top:10px;" onclick="toggleSettings()" data-i18n="add-key-first">⚠️ Add API Key First</button>
    </div>

    <div id="resultsCard" class="card hidden">
      <div id="transcriptBox" class="hidden">
        <div class="label" style="color:#667eea;" data-i18n="input-label">INPUT:</div>
        <div class="result-box question" id="transcriptText"></div>
      </div>

      <div id="loadingBox" class="hidden" style="text-align:center;padding:20px;">
        <div class="loading" style="font-size:32px;">⏳</div>
        <p style="color:#667eea;" data-i18n="getting-translation">Getting translation...</p>
      </div>

      <div id="errorBox" class="hidden">
        <div class="label" style="color:#ef4444;" data-i18n="error-label">❌ ERROR:</div>
        <div class="result-box error" id="errorMessage"></div>
        <div class="error-details" id="errorDetails"></div>
        <button class="btn btn-warning" onclick="toggleSettings()" style="margin-top:10px;" data-i18n="check-settings">Check Settings</button>
      </div>

      <div id="translationBox" class="hidden">
        <div class="label" style="color:#10b981;">
          <span data-i18n="output-label">OUTPUT:</span>
          <button class="speak-btn" id="speakTranslationBtn" onclick="toggleSpeech(state.translation, 'speakTranslationBtn')" title="Play/Stop pronunciation">🔊</button>
        </div>
        <div class="result-box answer" id="translationText"></div>
        <div class="speech-badge hidden" id="speechSupport">
          <span>🔊</span>
          <span data-i18n="pronunciation-available">Click speaker to hear pronunciation</span>
        </div>
        <button class="btn btn-success" onclick="saveFlashcard()" data-i18n="save-flashcard">➕ Save as Flashcard</button>
      </div>
    </div>

    <div id="flashcardsList" class="card hidden">
      <h3><span data-i18n="your-flashcards">📚 Your Flashcards</span> (<span id="listCount">0</span>)</h3>
      <div id="cardsContainer"></div>
    </div>
  </div>

  <div id="practiceMode" class="card hidden">
    <div id="practiceProgress" style="text-align:center;color:#667eea;font-weight:bold;margin-bottom:20px;">
      <span data-i18n="card-text">Card</span> <span id="currentCard">1</span> <span data-i18n="of-text">of</span> <span id="totalCards">0</span>
    </div>
    <div class="practice-card">
      <div id="practiceQuestion"></div>
      <div id="practiceAnswer" class="hidden"></div>
    </div>
    <button id="showAnswerBtn" class="btn btn-primary" onclick="showAnswer()" data-i18n="show-answer">Show Answer</button>
    <button id="nextCardBtn" class="btn btn-success hidden" onclick="nextCard()" data-i18n="next-card">✓ Next</button>
  </div>
</div>

<button id="settingsBtn" class="settings-btn" onclick="toggleSettings()">⚙️</button>

<script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore-compat.js"></script>

<script>
function toggleTutorial() {
  const tutorial = document.getElementById('apiTutorial');
  tutorial.classList.toggle('expanded');
}

const persianNumbers = {
  '1': 'اول', '2': 'دوم', '3': 'سوم', '4': 'چهارم', '5': 'پنجم',
  '6': 'ششم', '7': 'هفتم', '8': 'هشتم', '9': 'نهم', '10': 'دهم'
};

const translations = {
  en: {
    'main-title': "🎤 Roham's Language Learning",
    'main-subtitle': 'Learn Languages with AI • Create Flashcards • Practice Anytime!',
    'instruction-title': 'How Does It Work?',
    'instruction-text': 'Say or type any word, phrase, or sentence in Persian or English! The AI will translate it for you, and you can save translations as flashcards for future practice and learning.',
    'examples-title': 'Usage Examples',
    'example1-title': '🎤 Example 1: Persian to English - Say a Word',
    'example1-content': '<strong>What to say:</strong> "دانشگاه" (University)<br><strong>Result:</strong> The AI gives you English translations like "University" or "College" with practical examples',
    'example2-title': '✏️ Example 2: Persian to English - Write a Phrase',
    'example2-content': '<strong>What to write:</strong> "من امروز خیلی خوشحالم"<br><strong>Result:</strong> English translations with usage examples like "I\'m very happy today"',
    'example3-title': '🎤 Example 3: English to Persian - Say a Word',
    'example3-content': '<strong>What to say:</strong> "Happy"<br><strong>Result:</strong> The AI gives you Persian translations like "خوشحال", "شاد", "خرسند" with practical examples',
    'example4-title': '✏️ Example 4: English to Persian - Write a Sentence',
    'example4-content': '<strong>What to write:</strong> "I love learning new things"<br><strong>Result:</strong> Persian translations like "من عاشق یادگیری چیزهای جدید هستم"',
    'example5-title': '💾 Example 5: Save and Practice',
    'example5-content': 'After seeing the translation, click "Save as Flashcard". Then you can review your cards in the "Practice" section! 🎮',
    'example6-title': '🔊 Example 6: Listen to Pronunciation',
    'example6-content': 'Click the speaker icon 🔊 to hear the correct pronunciation!',
    'encrypted': '🔒 Encrypted',
    'multi-ai': '🤖 Multi-AI',
    'fa-to-en': 'فارسی → English',
    'en-to-fa': 'English → فارسی',
    'ai-gemini': '🌟 Gemini 2.x (FREE)',
    'ai-gpt': '⚡ GPT-4o (Paid)',
    'ai-claude': '🧠 Claude Sonnet (Paid)',
    'create-btn': '✏️ Create',
    'practice-btn': '🎮 Practice',
    'ios-warning-title': '⚠️ iOS Voice Input Blocked',
    'ios-warning-text': 'iOS is blocking voice input. Please check:<br>• Settings → Screen Time → Content Restrictions<br>• Try Text Input mode instead',
    'not-signed-in': 'You are not signed in.',
    'sign-in': '🔑 Sign in',
    'sign-out': 'Sign out',
    'sync-info': 'Sign in to sync flashcards across devices.',
    'settings-title': '⚙️ API Settings',
    'keys-encrypted': '🔒 Your API keys are encrypted before storage.',
    'gemini-title': '🌟 Gemini API (Google)',
    'free': 'FREE:',
    'get-key-at': 'Get key at',
    'model': 'Model',
    'try-alternates': 'Try alternates',
    'gemini-key-placeholder': 'Paste Gemini API key',
    'test-btn': '🧪 Test',
    'gpt-title': '⚡ OpenAI GPT-4',
    'paid': 'Paid',
    'get-key': 'Get Key',
    'gpt-key-placeholder': 'Paste OpenAI key',
    'claude-title': '🧠 Claude',
    'claude-key-placeholder': 'Paste Claude key',
    'save-btn': '💾 Save',
    'cancel-btn': 'Cancel',
    'voice-tab': '🎤 Voice',
    'text-tab': '⌨️ Text',
    'tap-to-speak': 'Tap to speak',
    'text-placeholder': 'Type in Persian or English...',
    'translate-btn': 'Translate →',
    'using-ai': 'Using: Gemini (Free)',
    'add-key-first': '⚠️ Add API Key First',
    'input-label': 'INPUT:',
    'getting-translation': 'Getting translation...',
    'error-label': '❌ ERROR:',
    'check-settings': 'Check Settings',
    'output-label': 'OUTPUT:',
    'save-flashcard': '➕ Save as Flashcard',
    'your-flashcards': '📚 Your Flashcards',
    'card-text': 'Card',
    'of-text': 'of',
    'show-answer': 'Show Answer',
    'next-card': '✓ Next',
    'question-label': 'QUESTION:',
    'answer-label': 'ANSWER:',
    'signed-in-as': 'Signed in as',
    'pronunciation-available': 'Click speaker to hear pronunciation'
  },
  fa: {
    'main-title': '🎤 یادگیری زبان رهام',
    'main-subtitle': 'با هوش مصنوعی زبان یاد بگیر • فلش‌کارت بساز • هر وقت تمرین کن!',
    'instruction-title': 'چطور کار می‌کنه؟',
    'instruction-text': 'اینجا میتونید هر کلمه، عبارت یا جمله‌ای که دوست دارین رو به فارسی یا انگلیسی بگین تا هوش مصنوعی براتون ترجمه‌ش رو بگه و بعد هم میتونید اون رو ذخیره کنین به صورت فلش‌کارت برای مرور و یادگیری بعدی!',
    'examples-title': 'مثال‌های استفاده',
    'example1-title': '🎤 مثال ۱: فارسی به انگلیسی - گفتن یک کلمه',
    'example1-content': '<strong>چی بگم:</strong> "دانشگاه"<br><strong>نتیجه:</strong> هوش مصنوعی چند ترجمه انگلیسی مثل "University" و "College" بهت میده با مثال‌هاشون',
    'example2-title': '✏️ مثال ۲: فارسی به انگلیسی - نوشتن یک عبارت',
    'example2-content': '<strong>چی بنویسم:</strong> "من امروز خیلی خوشحالم"<br><strong>نتیجه:</strong> ترجمه‌های انگلیسی مثل "I\'m very happy today" با مثال‌های کاربردی',
    'example3-title': '🎤 مثال ۳: انگلیسی به فارسی - گفتن یک کلمه',
    'example3-content': '<strong>چی بگم:</strong> "Happy"<br><strong>نتیجه:</strong> هوش مصنوعی چند ترجمه فارسی مثل "خوشحال"، "شاد"، "خرسند" بهت میده با مثال‌هاشون',
    'example4-title': '✏️ مثال ۴: انگلیسی به فارسی - نوشتن یک جمله',
    'example4-content': '<strong>چی بنویسم:</strong> "I love learning new things"<br><strong>نتیجه:</strong> ترجمه‌های فارسی مثل "من عاشق یادگیری چیزهای جدید هستم" با توضیحات کاربردی',
    'example5-title': '💾 مثال ۵: ذخیره و تمرین',
    'example5-content': 'بعد از اینکه ترجمه رو دیدی، روی دکمه "ذخیره به عنوان فلش‌کارت" بزن. بعد می‌تونی از قسمت "تمرین" کارت‌هات رو مرور کنی و یاد بگیری! 🎮',
    'example6-title': '🔊 مثال ۶: گوش دادن به تلفظ',
    'example6-content': 'روی آیکون بلندگو 🔊 کلیک کن تا تلفظ صحیح رو بشنوی و یاد بگیری!',
    'encrypted': '🔒 رمزنگاری شده',
    'multi-ai': '🤖 چند هوش مصنوعی',
    'fa-to-en': 'فارسی → English',
    'en-to-fa': 'English → فارسی',
    'ai-gemini': '🌟 Gemini 2.x (رایگان)',
    'ai-gpt': '⚡ GPT-4o (پولی)',
    'ai-claude': '🧠 Claude Sonnet (پولی)',
    'create-btn': '✏️ ساخت',
    'practice-btn': '🎮 تمرین',
    'ios-warning-title': '⚠️ ورودی صوتی iOS مسدود شده',
    'ios-warning-text': 'iOS ورودی صوتی را مسدود کرده. لطفاً بررسی کنید:<br>• تنظیمات ← زمان صفحه ← محدودیت‌های محتوا<br>• به جای آن حالت ورودی متنی را امتحان کنید',
    'not-signed-in': 'شما وارد نشده‌اید.',
    'sign-in': '🔑 ورود',
    'sign-out': 'خروج',
    'sync-info': 'برای همگام‌سازی فلش‌کارت‌ها در دستگاه‌های مختلف وارد شوید.',
    'settings-title': '⚙️ تنظیمات API',
    'keys-encrypted': '🔒 کلیدهای API شما قبل از ذخیره رمزنگاری می‌شوند.',
    'gemini-title': '🌟 Gemini API (گوگل)',
    'free': 'رایگان:',
    'get-key-at': 'دریافت کلید از',
    'model': 'مدل',
    'try-alternates': 'امتحان جایگزین‌ها',
    'gemini-key-placeholder': 'کلید Gemini API را بچسبانید',
    'test-btn': '🧪 تست',
    'gpt-title': '⚡ OpenAI GPT-4',
    'paid': 'پولی',
    'get-key': 'دریافت کلید',
    'gpt-key-placeholder': 'کلید OpenAI را بچسبانید',
    'claude-title': '🧠 Claude',
    'claude-key-placeholder': 'کلید Claude را بچسبانید',
    'save-btn': '💾 ذخیره',
    'cancel-btn': 'انصراف',
    'voice-tab': '🎤 صوتی',
    'text-tab': '⌨️ متنی',
    'tap-to-speak': 'برای صحبت کردن ضربه بزنید',
    'text-placeholder': 'به فارسی یا انگلیسی تایپ کنید...',
    'translate-btn': 'ترجمه →',
    'using-ai': 'استفاده از: Gemini (رایگان)',
    'add-key-first': '⚠️ ابتدا کلید API اضافه کنید',
    'input-label': 'ورودی:',
    'getting-translation': 'دریافت ترجمه...',
    'error-label': '❌ خطا:',
    'check-settings': 'بررسی تنظیمات',
    'output-label': 'خروجی:',
    'save-flashcard': '➕ ذخیره به عنوان فلش‌کارت',
    'your-flashcards': '📚 فلش‌کارت‌های شما',
    'card-text': 'کارت',
    'of-text': 'از',
    'show-answer': 'نمایش پاسخ',
    'next-card': '✓ بعدی',
    'question-label': 'سوال:',
    'answer-label': 'پاسخ:',
    'signed-in-as': 'وارد شده به عنوان',
    'pronunciation-available': 'روی بلندگو کلیک کنید تا تلفظ را بشنوید'
  }
};

let currentLang = 'fa';
let currentSpeech = null;
let currentSpeechBtn = null;
let translationDirection = 'fa-en';

function setTranslationDirection(direction) {
  translationDirection = direction;
  localStorage.setItem('translationDirection', direction);
  
  document.getElementById('dirFaEn').classList.toggle('active', direction === 'fa-en');
  document.getElementById('dirEnFa').classList.toggle('active', direction === 'en-fa');
}

function toggleSpeech(text, btnId) {
  const btn = document.getElementById(btnId);
  if (currentSpeech && currentSpeechBtn === btnId) {
    window.speechSynthesis.cancel();
    currentSpeech = null;
    currentSpeechBtn = null;
    if (btn) {
      btn.classList.remove('playing');
      btn.textContent = '🔊';
    }
    return;
  }
  speakText(text, btnId, translationDirection);
}

function speakText(text, btnId, direction) {
  if (currentSpeech) {
    window.speechSynthesis.cancel();
    if (currentSpeechBtn) {
      const oldBtn = document.getElementById(currentSpeechBtn);
      if (oldBtn) {
        oldBtn.classList.remove('playing');
        oldBtn.textContent = '🔊';
      }
    }
    currentSpeech = null;
    currentSpeechBtn = null;
  }

  if (!('speechSynthesis' in window)) {
    alert(currentLang === 'en' ? 'Text-to-speech not supported' : 'تبدیل متن به گفتار پشتیبانی نمی‌شود');
    return;
  }

  let cleanText = text.replace(/\*\*/g, '').replace(/<[^>]*>/g, '').replace(/^• /gm, '').trim();

  if (direction === 'en-fa') {
    cleanText = cleanText.replace(/گزینه (\d+):/g, (match, num) => 'مثال ' + (persianNumbers[num] || num) + ':');
  } else {
    cleanText = cleanText.replace(/Option (\d+):/g, (match, num) => 'مثال ' + (persianNumbers[num] || num) + ':');
  }
  
  cleanText = cleanText.replace(/^• /gm, 'مثال: ');

  const utterance = new SpeechSynthesisUtterance(cleanText);
  utterance.lang = (direction === 'fa-en') ? 'en-US' : 'fa-IR';
  utterance.rate = 0.85;
  utterance.pitch = 1.0;
  
  let btn = btnId ? document.getElementById(btnId) : null;
  currentSpeechBtn = btnId;
  
  if (btn) {
    btn.classList.add('playing');
    btn.textContent = '⏹️';
  }
  
  utterance.onend = () => {
    if (btn) {
      btn.classList.remove('playing');
      btn.textContent = '🔊';
    }
    currentSpeech = null;
    currentSpeechBtn = null;
  };
  
  utterance.onerror = () => {
    if (btn) {
      btn.classList.remove('playing');
      btn.textContent = '🔊';
    }
    currentSpeech = null;
    currentSpeechBtn = null;
  };
  
  currentSpeech = utterance;
  window.speechSynthesis.speak(utterance);
}

function stopSpeaking() {
  if (currentSpeech) {
    window.speechSynthesis.cancel();
    currentSpeech = null;
    if (currentSpeechBtn) {
      const btn = document.getElementById(currentSpeechBtn);
      if (btn) {
        btn.classList.remove('playing');
        btn.textContent = '🔊';
      }
      currentSpeechBtn = null;
    }
  }
}

function switchLanguage(lang) {
  currentLang = lang;
  localStorage.setItem('language', lang);
  
  document.body.className = lang === 'fa' ? 'rtl' : '';
  
  const buttons = document.querySelectorAll('.lang-btn');
  buttons.forEach(btn => btn.classList.remove('active'));
  event.target.classList.add('active');
  
  const tutorial = document.getElementById('apiTutorial');
  if (tutorial) {
    tutorial.style.display = lang === 'en' ? 'none' : 'block';
  }
  
  if (lang === 'en') {
    document.getElementById('instructionBox').style.display = 'none';
    document.getElementById('examplesBox').style.display = 'none';
  } else {
    document.getElementById('instructionBox').style.display = 'block';
    document.getElementById('examplesBox').style.display = 'block';
  }
  
  applyTranslations();
}

function applyTranslations() {
  const t = translations[currentLang];
  
  document.querySelectorAll('[data-i18n]').forEach(el => {
    const key = el.getAttribute('data-i18n');
    if (t[key]) el.innerHTML = t[key];
  });
  
  document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
    const key = el.getAttribute('data-i18n-placeholder');
    if (t[key]) el.placeholder = t[key];
  });
  
  document.querySelectorAll('[data-i18n-opt]').forEach(el => {
    const key = el.getAttribute('data-i18n-opt');
    if (t[key]) el.textContent = t[key];
  });
  
  updateDynamicTranslations();
}

function updateDynamicTranslations() {
  const names = {
    gemini: currentLang === 'en' ? 'Gemini (Free)' : 'Gemini (رایگان)',
    gpt: currentLang === 'en' ? 'GPT-4o (Paid)' : 'GPT-4o (پولی)',
    claude: currentLang === 'en' ? 'Claude (Paid)' : 'Claude (پولی)'
  };
  
  const aiStatus = document.getElementById('aiStatus');
  if (aiStatus) {
    const prefix = currentLang === 'en' ? 'Using: ' : 'استفاده از: ';
    aiStatus.textContent = prefix + names[state.aiProvider];
  }
}

const firebaseConfig={apiKey:"AIzaSyDlPErWZz-vu-mj1H_MwACZ_w_t7CFg4XI",authDomain:"flashcards-2025.firebaseapp.com",projectId:"flashcards-2025",storageBucket:"flashcards-2025.firebasestorage.app",messagingSenderId:"844930689761",appId:"1:844930689761:web:6bc626be70439c5265a5a0"};
firebase.initializeApp(firebaseConfig);
const auth=firebase.auth(),db=firebase.firestore();

function getDeviceFingerprint(){const c=document.createElement('canvas'),x=c.getContext('2d');x.textBaseline='top';x.font='14px Arial';x.fillText('fingerprint',2,2);return c.toDataURL().slice(-50)}
function simpleEncrypt(t,k){let e='';for(let i=0;i<t.length;i++)e+=String.fromCharCode(t.charCodeAt(i)^k.charCodeAt(i%k.length));return btoa(e)}
function simpleDecrypt(e,k){try{const d=atob(e);let r='';for(let i=0;i<d.length;i++)r+=String.fromCharCode(d.charCodeAt(i)^k.charCodeAt(i%k.length));return r}catch{return null}}

let state={mode:'create',inputMode:'voice',flashcards:[],aiProvider:'gemini',apiKeys:{gemini:'',gpt:'',claude:''},transcript:'',translation:'',
currentCardIndex:0,showingAnswer:false,isListening:false,deviceKey:getDeviceFingerprint(),geminiModel:'gemini-2.0-flash-exp',geminiTryAlternates:true};

let recognitionAttempts=0;
const MAX_ATTEMPTS=2;

function loadGeminiPrefs(){const m=localStorage.getItem('geminiModel');const t=localStorage.getItem('geminiTryAlternates');if(m)state.geminiModel=m;if(t!==null)state.geminiTryAlternates=(t==='true');document.getElementById('geminiModel').value=state.geminiModel;document.getElementById('geminiTryAlt').checked=state.geminiTryAlternates}
function saveGeminiPrefs(){state.geminiModel=document.getElementById('geminiModel').value;state.geminiTryAlternates=document.getElementById('geminiTryAlt').checked;localStorage.setItem('geminiModel',state.geminiModel);localStorage.setItem('geminiTryAlternates',state.geminiTryAlternates)}

function loadData(){
  const savedCards=localStorage.getItem('flashcards');
  const savedProvider=localStorage.getItem('aiProvider');
  const savedLang=localStorage.getItem('language');
  const savedDirection=localStorage.getItem('translationDirection');
  
  if(savedDirection){
    translationDirection=savedDirection;
    setTranslationDirection(savedDirection);
  }
  
  if(savedLang){
    currentLang=savedLang;
    document.body.className=savedLang==='fa'?'rtl':'';
    document.querySelectorAll('.lang-btn').forEach((btn,i)=>{
      btn.classList.toggle('active',savedLang===(i===0?'en':'fa'))
    });
  } else {
    currentLang='fa';
    document.body.className='rtl';
    document.querySelectorAll('.lang-btn')[1].classList.add('active');
  }
  
  if(savedCards){state.flashcards=JSON.parse(savedCards);updateCardCount();renderFlashcards()}
  if(savedProvider){state.aiProvider=savedProvider;document.getElementById('aiProvider').value=savedProvider}
  
  ['gemini','gpt','claude'].forEach(p=>{
    const enc=localStorage.getItem(`${p}ApiKey_enc`);
    if(enc){
      const dec=simpleDecrypt(enc,state.deviceKey);
      if(dec){
        state.apiKeys[p]=dec;
        const el=document.getElementById(`${p}Key`);
        if(el)el.value='••••••••'+dec.slice(-8)
      }
    }
  });
  
  loadGeminiPrefs();
  updateAIProvider();
  applyTranslations();
  
  const tutorial = document.getElementById('apiTutorial');
  if (tutorial && currentLang === 'en') {
    tutorial.style.display = 'none';
  }
  
  if (currentLang === 'en') {
    document.getElementById('instructionBox').style.display = 'none';
    document.getElementById('examplesBox').style.display = 'none';
  }
  
  if ('speechSynthesis' in window) {
    document.getElementById('speechSupport').classList.remove('hidden');
  }
}

const provider=new firebase.auth.GoogleAuthProvider();
document.getElementById('loginBtn').onclick=()=>auth.signInWithPopup(provider);
document.getElementById('logoutBtn').onclick=()=>auth.signOut();

let cardsRef=null;
auth.onAuthStateChanged(async(user)=>{
  if(user){
    document.getElementById('loginBtn').style.display='none';
    document.getElementById('logoutBtn').style.display='inline-block';
    const prefix = currentLang === 'en' ? 'Signed in as ' : 'وارد شده به عنوان ';
    document.getElementById('who').innerHTML=`${prefix}<span class="user-pill">${user.displayName||user.email}</span>`;
    cardsRef=db.collection('users').doc(user.uid).collection('flashcards');
    const local=JSON.parse(localStorage.getItem('flashcards')||'[]');
    if(local.length){
      const batch=db.batch();
      local.forEach(c=>batch.set(cardsRef.doc(String(c.id)),c));
      await batch.commit();
      localStorage.removeItem('flashcards');
    }
    cardsRef.orderBy('created','desc').onSnapshot(snap=>{
      state.flashcards=snap.docs.map(d=>d.data());
      updateCardCount();
      renderFlashcards();
    });
  }else{
    document.getElementById('loginBtn').style.display='inline-block';
    document.getElementById('logoutBtn').style.display='none';
    document.getElementById('who').textContent=translations[currentLang]['not-signed-in'];
    const local=JSON.parse(localStorage.getItem('flashcards')||'[]');
    state.flashcards=local;
    updateCardCount();
    renderFlashcards();
  }
});

function updateAIProvider(){
  state.aiProvider=document.getElementById('aiProvider').value;
  localStorage.setItem('aiProvider',state.aiProvider);
  updateDynamicTranslations();
  checkApiKey();
}

function checkApiKey(){
  const btn=document.getElementById('needKeyBtn');
  btn.classList.toggle('hidden',!!state.apiKeys[state.aiProvider]);
}

function toggleSettings(){
  const p=document.getElementById('settingsPanel');
  const b=document.getElementById('settingsBtn');
  p.classList.toggle('hidden');
  b.classList.toggle('hidden');
  if(!p.classList.contains('hidden'))loadGeminiPrefs();
  else saveGeminiPrefs();
}

function saveAllKeys(){
  let saved=0;
  ['gemini','gpt','claude'].forEach(p=>{
    const key=document.getElementById(`${p}Key`).value.trim();
    if(key&&!key.startsWith('••••')){
      state.apiKeys[p]=key;
      localStorage.setItem(`${p}ApiKey_enc`,simpleEncrypt(key,state.deviceKey));
      saved++;
    }
  });
  saveGeminiPrefs();
  const msg=currentLang==='en'?`✅ Saved ${saved} key(s)!`:`✅ ${saved} کلید ذخیره شد!`;
  alert(saved?msg:(currentLang==='en'?'No new keys.':'کلید جدیدی نیست.'));
  checkApiKey();
}

function setInputMode(mode){
  state.inputMode=mode;
  const tabs=document.querySelectorAll('.input-tab');
  tabs[0].classList.toggle('active',mode==='voice');
  tabs[1].classList.toggle('active',mode==='text');
  document.getElementById('voiceInput').style.display=mode==='voice'?'block':'none';
  document.getElementById('textInput').classList.toggle('active',mode==='text');
}

function processText(){
  const text=document.getElementById('textArea').value.trim();
  if(!text){
    alert(currentLang==='en'?'Please enter some text!':'لطفاً متنی وارد کنید!');
    return;
  }
  if(!state.apiKeys[state.aiProvider]){
    alert(currentLang==='en'?'Please add API key!':'لطفاً کلید API اضافه کنید!');
    toggleSettings();
    return;
  }
  state.transcript=text;
  showTranscript();
  getTranslation(text);
}

async function startListening(){
  if(!state.apiKeys[state.aiProvider]){
    alert(currentLang==='en'?'Please add API key!':'لطفاً کلید API اضافه کنید!');
    toggleSettings();
    return;
  }
  if(!('webkitSpeechRecognition'in window)){
    alert(currentLang==='en'?"Voice not supported. Try Text mode.":"صدا پشتیبانی نمی‌شود. حالت متنی را امتحان کنید.");
    setInputMode('text');
    return;
  }
  
  recognitionAttempts=0;
  startSpeechRecognition();
}

function startSpeechRecognition(){
  const recognition=new webkitSpeechRecognition();
  recognition.continuous=false;
  recognition.interimResults=false;
  recognition.lang = (translationDirection === 'fa-en') ? 'fa-IR' : 'en-US';
  
  let gotResults=false;
  let transcript='';
  
  recognition.onstart=()=>{
    state.isListening=true;
    document.getElementById('micButton').classList.add('listening');
    document.getElementById('micButton').textContent='🔴';
    document.getElementById('statusText').textContent=currentLang==='en'?'🎤 Listening...':'🎤 در حال گوش دادن...';
  };
  
  recognition.onresult=(event)=>{
    gotResults=true;
    transcript=event.results[0][0].transcript;
  };
  
  recognition.onerror=(event)=>{
    if(event.error==='aborted'&&recognitionAttempts<MAX_ATTEMPTS){
      recognitionAttempts++;
      setTimeout(()=>{startSpeechRecognition()},500);
      return;
    }
    
    resetMicButton();
    
    if(event.error==='not-allowed'||event.error==='service-not-allowed'){
      document.getElementById('iosWarning').classList.remove('hidden');
      setTimeout(()=>{setInputMode('text')},2000);
    }else{
      alert(currentLang==='en'?'Voice error. Try Text mode instead.':'خطای صوتی. حالت متنی را امتحان کنید.');
      setInputMode('text');
    }
  };
  
  recognition.onend=()=>{
    if(gotResults&&transcript.trim()){
      state.transcript=transcript.trim();
      showTranscript();
      getTranslation(state.transcript);
    }else if(!gotResults&&recognitionAttempts===0){
      recognitionAttempts++;
      setTimeout(()=>{startSpeechRecognition()},500);
      return;
    }
    resetMicButton();
  };
  
  try{
    recognition.start();
  }catch(error){
    resetMicButton();
    setInputMode('text');
  }
}

function resetMicButton(){
  state.isListening=false;
  document.getElementById('micButton').classList.remove('listening');
  document.getElementById('micButton').textContent='🎤';
  document.getElementById('statusText').textContent=translations[currentLang]['tap-to-speak'];
}

function showTranscript(){
  document.getElementById('resultsCard').classList.remove('hidden');
  document.getElementById('transcriptBox').classList.remove('hidden');
  document.getElementById('transcriptText').textContent=state.transcript;
  document.getElementById('errorBox').classList.add('hidden');
}

const GEMINI_BASE='https://generativelanguage.googleapis.com';
async function geminiGenerate({model,key,prompt}){
  const url=`${GEMINI_BASE}/v1beta/models/${model}:generateContent?key=${encodeURIComponent(key)}`;
  const res=await fetch(url,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({contents:[{parts:[{text:prompt}]}]})
  });
  const data=await res.json();
  return{ok:res.ok,status:res.status,url,data};
}

function uniq(a){return[...new Set(a)]}
function modelTryOrder(primary){return uniq([primary,'gemini-2.0-flash-exp','gemini-1.5-flash','gemini-1.5-pro'])}

async function testApiKey(provider){
  const input=document.getElementById(`${provider}Key`).value.trim();
  const testKey=input.startsWith('••••')?state.apiKeys[provider]:input;
  if(!testKey){
    alert(currentLang==='en'?'Enter key first!':'ابتدا کلید را وارد کنید!');
    return;
  }
  alert(currentLang==='en'?'Testing...':'در حال تست...');
  try{
    if(provider==='gemini'){
      saveGeminiPrefs();
      const models=state.geminiTryAlternates?modelTryOrder(state.geminiModel):[state.geminiModel];
      for(const m of models){
        const r=await geminiGenerate({model:m,key:testKey,prompt:"Say 'Hello'"});
        if(r.ok&&r.data&&r.data.candidates){
          alert(`✅ ${currentLang==='en'?'Works with':'کار می‌کند با'} "${m}"\n\n`+r.data.candidates[0].content.parts[0].text);
          return;
        }
      }
      alert(currentLang==='en'?'❌ Error':'❌ خطا');
    }else if(provider==='gpt'){
      const r=await fetch('https://api.openai.com/v1/chat/completions',{
        method:'POST',
        headers:{'Content-Type':'application/json','Authorization':`Bearer ${testKey}`},
        body:JSON.stringify({model:'gpt-4o-mini',messages:[{role:'user',content:"Say 'Hello'"}],max_tokens:50})
      });
      const d=await r.json();
      alert(r.ok&&d.choices?(`✅ ${currentLang==='en'?'Works':'کار می‌کند'}\n\n`+d.choices[0].message.content):(`❌ ${currentLang==='en'?'Error':'خطا'}`));
    }else if(provider==='claude'){
      const r=await fetch('https://api.anthropic.com/v1/messages',{
        method:'POST',
        headers:{'Content-Type':'application/json','x-api-key':testKey,'anthropic-version':'2023-06-01'},
        body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:100,messages:[{role:'user',content:"Say 'Hello'"}]})
      });
      const d=await r.json();
      alert(r.ok&&d.content?(`✅ ${currentLang==='en'?'Works':'کار می‌کند'}\n\n`+d.content[0].text):(`❌ ${currentLang==='en'?'Error':'خطا'}`));
    }
  }catch(e){
    alert(`❌ ${currentLang==='en'?'Error':'خطا'}: `+e.message);
  }
}

async function getTranslation(text){
  document.getElementById('loadingBox').classList.remove('hidden');
  document.getElementById('translationBox').classList.add('hidden');
  document.getElementById('errorBox').classList.add('hidden');
  
  let prompt;
  
  if (translationDirection === 'fa-en') {
    prompt=`Extract the Persian word/phrase from this input and translate it to natural English.

INPUT: "${text}"

INSTRUCTIONS:
1. Identify the core Persian expression
2. Provide 2-4 natural English translations
3. Give practical example sentences

OUTPUT FORMAT:

**Option 1:** [English translation]
• Example: [Short example]

**Option 2:** [Alternative translation]
• Example: [Short example]

**Option 3:** [Another variation]
• Example: [Short example]

RULES:
✓ Use bullet points (•)
✓ Bold with **Option 1:**, **Option 2:**
✓ Keep examples under 12 words
✓ NO grammar explanations
✓ NO extra commentary`;
  } else {
    prompt=`Extract the English word/phrase from this input and translate it to natural Persian.

INPUT: "${text}"

INSTRUCTIONS:
1. Identify the core English expression
2. Provide 2-4 natural Persian translations (in Persian script)
3. Give practical example sentences in Persian

OUTPUT FORMAT:

**گزینه ۱:** [ترجمه فارسی]
• مثال: [مثال کوتاه به فارسی]

**گزینه ۲:** [ترجمه جایگزین]
• مثال: [مثال کوتاه به فارسی]

**گزینه ۳:** [نوع دیگر]
• مثال: [مثال کوتاه به فارسی]

RULES:
✓ Use bullet points (•)
✓ Bold with **گزینه ۱:**, **گزینه ۲:**
✓ Keep examples under 12 words
✓ ALL text in Persian
✓ NO English
✓ NO grammar explanations`;
  }

  try{
    if(state.aiProvider==='gemini'){
      saveGeminiPrefs();
      const models=state.geminiTryAlternates?modelTryOrder(state.geminiModel):[state.geminiModel];
      for(const m of models){
        const r=await geminiGenerate({model:m,key:state.apiKeys.gemini,prompt});
        if(r.ok&&r.data&&r.data.candidates){
          state.translation=r.data.candidates[0].content.parts[0].text.trim();
          showTranslation();
          document.getElementById('loadingBox').classList.add('hidden');
          return;
        }
      }
      showError(currentLang==='en'?'Gemini Error':'خطای Gemini',currentLang==='en'?'Try different model':'مدل دیگری را امتحان کنید');
    }else if(state.aiProvider==='gpt'){
      const r=await fetch('https://api.openai.com/v1/chat/completions',{
        method:'POST',
        headers:{'Content-Type':'application/json','Authorization':`Bearer ${state.apiKeys.gpt}`},
        body:JSON.stringify({model:'gpt-4o-mini',messages:[{role:'user',content:prompt}],max_tokens:300})
      });
      const d=await r.json();
      if(r.ok&&d.choices){
        state.translation=d.choices[0].message.content.trim();
        showTranslation();
      }else{
        showError(currentLang==='en'?'OpenAI Error':'خطای OpenAI',JSON.stringify(d,null,2));
      }
    }else if(state.aiProvider==='claude'){
      const r=await fetch('https://api.anthropic.com/v1/messages',{
        method:'POST',
        headers:{'Content-Type':'application/json','x-api-key':state.apiKeys.claude,'anthropic-version':'2023-06-01'},
        body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:300,messages:[{role:'user',content:prompt}]})
      });
      const d=await r.json();
      if(r.ok&&d.content){
        state.translation=d.content[0].text.trim();
        showTranslation();
      }else{
        showError(currentLang==='en'?'Claude Error':'خطای Claude',JSON.stringify(d,null,2));
      }
    }
  }catch(e){
    showError(currentLang==='en'?'Network Error':'خطای شبکه',e.message);
  }
  document.getElementById('loadingBox').classList.add('hidden');
}

function showError(message,details){
  document.getElementById('errorBox').classList.remove('hidden');
  document.getElementById('translationBox').classList.add('hidden');
  document.getElementById('errorMessage').textContent=message;
  document.getElementById('errorDetails').textContent=details;
}

function formatTranslation(text){
  if (translationDirection === 'en-fa') {
    return text
      .replace(/\*\*گزینه (\d+):\*\*/g,'<strong style="color:#667eea;font-size:16px;">گزینه $1:</strong>')
      .replace(/^• /gm,'<span style="color:#10b981;">•</span> ')
      .replace(/\n/g,'<br>');
  }
  
  return text
    .replace(/\*\*Option (\d+):\*\*/g,'<strong style="color:#667eea;font-size:16px;">Option $1:</strong>')
    .replace(/^• /gm,'<span style="color:#10b981;">•</span> ')
    .replace(/\n/g,'<br>');
}

function showTranslation(){
  document.getElementById('translationBox').classList.remove('hidden');
  document.getElementById('errorBox').classList.add('hidden');
  document.getElementById('translationText').innerHTML=formatTranslation(state.translation);
}

async function saveFlashcard(){
  if(!state.transcript||!state.translation){
    alert(currentLang==='en'?'Need both!':'هر دو لازم است!');
    return;
  }
  const newCard={
    id:Date.now(),
    question:state.transcript,
    answer:state.translation,
    created:new Date().toISOString(),
    aiProvider:state.aiProvider,
    direction:translationDirection,
    reviewCount:0
  };
  const user=auth.currentUser;
  if(user){
    await db.collection('users').doc(user.uid).collection('flashcards').doc(String(newCard.id)).set(newCard);
  }else{
    state.flashcards.unshift(newCard);
    localStorage.setItem('flashcards',JSON.stringify(state.flashcards));
  }
  state.transcript='';
  state.translation='';
  document.getElementById('textArea').value='';
  document.getElementById('resultsCard').classList.add('hidden');
  document.getElementById('transcriptBox').classList.add('hidden');
  document.getElementById('translationBox').classList.add('hidden');
  updateCardCount();
  renderFlashcards();
  alert(currentLang==='en'?'Saved! 🎉':'ذخیره شد! 🎉');
}

async function deleteCard(id){
  if(!confirm(currentLang==='en'?'Delete?':'حذف شود?'))return;
  const user=auth.currentUser;
  if(user){
    await db.collection('users').doc(user.uid).collection('flashcards').doc(String(id)).delete();
  }else{
    state.flashcards=state.flashcards.filter(c=>c.id!==id);
    localStorage.setItem('flashcards',JSON.stringify(state.flashcards));
  }
  updateCardCount();
  renderFlashcards();
}

function updateCardCount(){
  document.getElementById('cardCount').textContent=state.flashcards.length;
  document.getElementById('listCount').textContent=state.flashcards.length;
  if(state.flashcards.length>0)document.getElementById('flashcardsList').classList.remove('hidden');
}

function renderFlashcards(){
  const c=document.getElementById('cardsContainer');
  c.innerHTML='';
  const aiEmojis={gemini:'🌟',gpt:'⚡',claude:'🧠'};
  const qLabel=currentLang==='en'?'Q:':'س:';
  const aLabel=currentLang==='en'?'A:':'پ:';
  const listenText=translations[currentLang]['pronunciation-available'];
  
  state.flashcards.forEach(card=>{
    const el=document.createElement('div');
    el.className='flashcard-item';
    const cardId = 'card_' + card.id;
    const dir = card.direction || 'fa-en';
    const directionEmoji = (dir === 'en-fa') ? '🇬🇧→🇮🇷' : '🇮🇷→🇬🇧';
    const answerEscaped = card.answer.replace(/`/g, '\\`').replace(/\$/g, '\\
    ).replace(/\n/g, ' ');
    
    el.innerHTML=`
      <div style="font-size:11px;color:#999;margin-bottom:4px;">${aiEmojis[card.aiProvider]||'🤖'} ${card.aiProvider} ${directionEmoji}</div>
      <div style="font-size:14px;color:#666;margin-bottom:8px;"><strong>${qLabel}</strong> ${card.question}</div>
      <div style="font-size:14px;color:#10b981;line-height:1.7;">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">
          <strong>${aLabel}</strong>
          <button class="speak-btn" id="${cardId}" onclick="speakText(\`${answerEscaped}\`, '${cardId}', '${dir}')" title="${listenText}" style="width:24px;height:24px;font-size:12px;">🔊</button>
        </div>
        ${formatTranslation(card.answer)}
