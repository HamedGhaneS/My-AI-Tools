<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Triple Pendulum ‚Äî Smooth + Tactile Controls (Pure JS)</title>
<style>
  :root{
    --bg:#0d1117; --panel:#0f172a; --ink:#e5e7eb; --muted:#9ca3af;
    --c1:#22d3ee; --c2:#60a5fa; --c3:#f472b6; --ok:#22c55e; --pause:#f59e0b;
    --edge:#1f2937; --edge2:#273449;
  }
  html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial}
  .container{max-width:1100px;margin:16px auto;padding:0 12px}
  .panel{background:linear-gradient(180deg,var(--panel),#0b1224); border:1px solid var(--edge); border-radius:14px; padding:12px; box-shadow:0 10px 30px rgba(0,0,0,.35)}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .title{font-weight:700}
  .badge{font-size:12px;color:var(--muted);padding-left:6px}
  .status{margin-left:10px; padding:.25rem .55rem; border-radius:999px; font-weight:600; letter-spacing:.02em; font-size:12px; border:1px solid var(--edge2); transition:.25s ease}
  .status.play{background:rgba(34,197,94,.12); color:#86efac; box-shadow:0 0 0 0 rgba(34,197,94,.35); animation:pulse 1.6s ease-out infinite}
  .status.pause{background:rgba(245,158,11,.12); color:#fcd34d}
  @keyframes pulse{to{box-shadow:0 0 0 14px rgba(34,197,94,0)}}

  /* Buttons with tactile feedback + ripple */
  .btn{position:relative; overflow:hidden; background:#1f2937; border:1px solid #374151; color:var(--ink);
       padding:10px 14px; border-radius:10px; cursor:pointer; transition:transform .08s ease, background .2s ease, border-color .25s ease}
  .btn:hover{background:#273449}
  .btn:active{transform:translateY(1px) scale(.99)}
  .btn.primary{background:#2563eb; border-color:#1d4ed8}
  .btn.primary:hover{background:#1f51d6}
  .btn.warn{background:#7c3aed; border-color:#6d28d9}
  .btn[aria-pressed="true"]{box-shadow:0 0 0 2px rgba(99,102,241,.25) inset}
  .ripple{position:absolute; border-radius:50%; transform:scale(0); background:rgba(255,255,255,.35); animation:ripple .5s linear; pointer-events:none}
  @keyframes ripple{to{transform:scale(3.5); opacity:0}}

  label{display:grid;grid-template-columns:170px 1fr 70px;gap:8px;align-items:center;color:var(--muted)}
  input[type="range"]{width:100%}
  input[type="number"]{width:72px;background:#0b0f14;border:1px solid var(--edge);color:var(--ink);border-radius:8px;padding:6px 8px}
  .legend{display:flex;gap:14px;margin-top:6px;color:#9ca3af;font-size:12px}
  .chip{display:inline-flex;align-items:center;gap:6px}
  .dot{width:10px;height:10px;border-radius:50%}

  .board{position:relative;margin-top:12px}
  canvas{display:block;width:100%;max-width:1100px;height:auto;background:#0b0f14;border:1px solid var(--edge);border-radius:14px}

  .small{font-size:12px;color:#9ca3af}
  .col{flex:1;min-width:280px}
  .check{display:flex;align-items:center;gap:8px;color:#9ca3af}
</style>
</head>
<body>
<div class="container">
  <div class="panel">
    <div class="row" style="justify-content:space-between">
      <div class="row">
        <div class="title">Triple Pendulum</div>
        <div class="badge">Newtonian ‚Ä¢ constrained rods ‚Ä¢ fixed timestep</div>
        <div id="stateBadge" class="status play">RUNNING</div>
      </div>
      <div class="row">
        <button id="toggleBtn" class="btn primary" aria-pressed="true">‚èµ Start / Pause</button>
        <button id="resetBtn" class="btn warn">‚ü≤ Reset</button>
        <button id="randBtn" class="btn">üé≤ Randomise</button>
      </div>
    </div>

    <div class="row" style="margin-top:10px">
      <div class="col">
        <label>Length L1 (px)
          <input type="range" id="L1" min="60" max="260" step="1" value="170">
          <input type="number" id="L1n" value="170">
        </label>
        <label>Length L2 (px)
          <input type="range" id="L2" min="60" max="260" step="1" value="170">
          <input type="number" id="L2n" value="170">
        </label>
        <label>Length L3 (px)
          <input type="range" id="L3" min="60" max="260" step="1" value="170">
          <input type="number" id="L3n" value="170">
        </label>
      </div>

      <div class="col">
        <label>Mass m1
          <input type="range" id="m1" min="0.5" max="3" step="0.1" value="1">
          <input type="number" id="m1n" value="1" step="0.1">
        </label>
        <label>Mass m2
          <input type="range" id="m2" min="0.5" max="3" step="0.1" value="1">
          <input type="number" id="m2n" value="1" step="0.1">
        </label>
        <label>Mass m3
          <input type="range" id="m3" min="0.5" max="3" step="0.1" value="1">
          <input type="number" id="m3n" value="1" step="0.1">
        </label>
      </div>

      <div class="col">
        <label>Gravity g (px/s¬≤)
          <input type="range" id="grav" min="200" max="1600" step="10" value="800">
          <input type="number" id="gravn" value="800">
        </label>
        <label>Damping (0.97‚Äì1.00)
          <input type="range" id="damp" min="0.970" max="1.000" step="0.001" value="0.998">
          <input type="number" id="dampn" value="0.998" step="0.001">
        </label>
        <label>Sub-steps / frame
          <input type="range" id="steps" min="1" max="12" step="1" value="6">
          <input type="number" id="stepsn" value="6">
        </label>
      </div>

      <div class="col">
        <label>Time scale (√ó)
          <input type="range" id="times" min="0.25" max="1.50" step="0.01" value="0.75">
          <input type="number" id="timesn" value="0.75" step="0.01">
        </label>
        <label>Random angle range (¬∞)
          <input type="range" id="arange" min="30" max="140" step="1" value="90">
          <input type="number" id="arangenn" value="90">
        </label>
        <div class="check" style="margin-top:4px">
          <input type="checkbox" id="zerovel" checked>
          <label for="zerovel">Zero velocities on randomise</label>
        </div>
      </div>
    </div>

    <div class="legend">
      <span class="chip"><span class="dot" style="background:var(--c1)"></span> arm 1</span>
      <span class="chip"><span class="dot" style="background:var(--c2)"></span> arm 2</span>
      <span class="chip"><span class="dot" style="background:var(--c3)"></span> arm 3</span>
      <span>‚Ä¢ Trails drawn on a buffer canvas for smoothness</span>
    </div>
  </div>

  <div class="board">
    <!-- main drawing surface -->
    <canvas id="view" width="1100" height="680"></canvas>
    <!-- trail buffer (same size, drawn under arms) -->
    <canvas id="trail" width="1100" height="680" style="position:absolute; inset:0; border-radius:14px; pointer-events:none"></canvas>
  </div>
  <div class="small" id="hud" style="margin-top:6px; opacity:.8"></div>
</div>

<script>
/* ------------------------- Utilities / UI wiring ------------------------- */
const $ = (id)=>document.getElementById(id);
function bindRangeNumber(rId,nId,on){
  const r=$(rId), n=$(nId);
  const sync=(src,dst)=>{dst.value=src.value; on(+src.value);};
  r.addEventListener('input',()=>sync(r,n));
  n.addEventListener('input',()=>sync(n,r));
  on(+r.value);
}
function ripple(e){
  const b=e.currentTarget, r=document.createElement('span'); r.className='ripple';
  const rect=b.getBoundingClientRect(); const x=e.clientX-rect.left, y=e.clientY-rect.top;
  r.style.left=(x-10)+'px'; r.style.top=(y-10)+'px'; r.style.width=r.style.height='20px';
  b.appendChild(r); setTimeout(()=>r.remove(),500);
}

/* ------------------------------ Parameters ------------------------------ */
const P = {
  L1:170,L2:170,L3:170,
  m1:1,m2:1,m3:1,
  g:800,damping:0.998,
  subSteps:6, timeScale:0.75,
  angleRangeDeg:90
};
bindRangeNumber('L1','L1n',v=>P.L1=v);
bindRangeNumber('L2','L2n',v=>P.L2=v);
bindRangeNumber('L3','L3n',v=>P.L3=v);
bindRangeNumber('m1','m1n',v=>P.m1=v);
bindRangeNumber('m2','m2n',v=>P.m2=v);
bindRangeNumber('m3','m3n',v=>P.m3=v);
bindRangeNumber('grav','gravn',v=>P.g=v);
bindRangeNumber('damp','dampn',v=>P.damping=v);
bindRangeNumber('steps','stepsn',v=>P.subSteps=v|0);
bindRangeNumber('times','timesn',v=>P.timeScale=v);
bindRangeNumber('arange','arangenn',v=>P.angleRangeDeg=v);
const zeroVelChk = $('zerovel');

/* ------------------------------ Canvas setup ---------------------------- */
const view = $('view'), tv = view.getContext('2d');
const trail = $('trail'), tt = trail.getContext('2d');
const HUD = $('hud');
const DPR = Math.min(window.devicePixelRatio||1,2);
[view,trail].forEach(c=>{
  const w=c.width, h=c.height;
  c.width=w*DPR; c.height=h*DPR; c.style.width=w+'px'; c.style.height=h+'px';
  c.getContext('2d').setTransform(DPR,0,0,DPR,0,0);
});
const pivot = { x:view.width/(2*DPR), y:view.height/(5.5*DPR) };
const COL1=getComputedStyle(document.documentElement).getPropertyValue('--c1').trim()||'#22d3ee';
const COL2=getComputedStyle(document.documentElement).getPropertyValue('--c2').trim()||'#60a5fa';
const COL3=getComputedStyle(document.documentElement).getPropertyValue('--c3').trim()||'#f472b6';
const BG='rgba(11,15,20,0.35)';

/* ----------------------------- Physics model ---------------------------- */
/*
  We model three point masses connected by inextensible, massless rods.
  Forces: gravity only. Tiny linear damping approximates air drag.

  Integrator: fixed-timestep accumulator @ 240 Hz.
  Step: RK2 (midpoint) symplectic-like on free motion, then project constraints
        repeatedly (position-based dynamics).
  Constraint projection for rod AB with length L:
    d = B - A; dist = |d|; corr = (dist - L) * d/dist
    A += -(wA/(wA+wB)) * corr ; B += +(wB/(wA+wB)) * corr
  After projections, inject a fraction of the accumulated correction back into
  velocity (keeps energy consistent but stable).
*/
const dtFixed = 1/240;
const iters = 8;
const velFeedback = 0.85;
const vClamp = 1800;

function makeBob(x,y,m){ return {x,y,vx:0,vy:0,m,inv:1/m}; }
let p1,p2,p3;

function reset(ang){
  const a1 = ang?ang[0]:Math.PI*0.85;
  const a2 = ang?ang[1]:-Math.PI*0.55;
  const a3 = ang?ang[2]:Math.PI*0.75;
  p1=makeBob(pivot.x + P.L1*Math.sin(a1), pivot.y + P.L1*Math.cos(a1), P.m1);
  p2=makeBob(p1.x     + P.L2*Math.sin(a2), p1.y     + P.L2*Math.cos(a2), P.m2);
  p3=makeBob(p2.x     + P.L3*Math.sin(a3), p2.y     + P.L3*Math.cos(a3), P.m3);
  p1.vx=p1.vy=p2.vx=p2.vy=p3.vx=p3.vy=0;
  tt.clearRect(0,0,trail.width/DPR, trail.height/DPR); // wipe trails
}
function randomise(){
  const r = (deg)=>((Math.random()*2-1)*deg)*Math.PI/180;
  const base = Math.PI;
  const a1 = base + r(P.angleRangeDeg*0.9);
  const a2 = r(P.angleRangeDeg);
  const a3 = r(P.angleRangeDeg);
  reset([a1,a2,a3]);
  if(!zeroVelChk.checked){
    p1.vx=(Math.random()-.5)*60; p2.vx=(Math.random()-.5)*60; p3.vx=(Math.random()-.5)*60;
  }
}

/* constraints */
function projPivot(p,L){
  const dx=p.x-pivot.x, dy=p.y-pivot.y, dist=Math.hypot(dx,dy)||1e-6;
  const diff=(dist-L)/dist, cx=dx*diff, cy=dy*diff;
  p.x-=cx; p.y-=cy; return {cx:-cx, cy:-cy};
}
function proj(a,b,L){
  const dx=b.x-a.x, dy=b.y-a.y, dist=Math.hypot(dx,dy)||1e-6;
  const diff=(dist-L)/dist, cx=dx*diff, cy=dy*diff;
  const w1=a.inv, w2=b.inv, d=w1+w2||1e-9;
  const ax=-(w1/d)*cx, ay=-(w1/d)*cy;
  const bx=(w2/d)*cx,  by=(w2/d)*cy;
  a.x+=ax; a.y+=ay; b.x+=bx; b.y+=by;
  return {a:{cx:ax,cy:ay}, b:{cx:bx,cy:by}};
}

/* one physics substep */
function substep(dt){
  const g=P.g, damp=P.damping;

  // RK2 midpoint on free motion (gravity)
  // 1) half-kick
  p1.vy += 0.5*g*dt; p2.vy += 0.5*g*dt; p3.vy += 0.5*g*dt;

  // damping
  p1.vx*=damp; p1.vy*=damp;
  p2.vx*=damp; p2.vy*=damp;
  p3.vx*=damp; p3.vy*=damp;

  // 2) drift
  p1.x += p1.vx*dt; p1.y += p1.vy*dt;
  p2.x += p2.vx*dt; p2.y += p2.vy*dt;
  p3.x += p3.vx*dt; p3.y += p3.vy*dt;

  // 3) project constraints iteratively (rigid rods)
  let a1={x:0,y:0}, a2={x:0,y:0}, a3={x:0,y:0};
  for(let i=0;i<iters;i++){
    const c1 = projPivot(p1,P.L1); a1.x+=c1.cx; a1.y+=c1.cy;
    const c12= proj(p1,p2,P.L2);   a1.x+=c12.a.cx; a1.y+=c12.a.cy; a2.x+=c12.b.cx; a2.y+=c12.b.cy;
    const c23= proj(p2,p3,P.L3);   a2.x+=c23.a.cx; a2.y+=c23.a.cy; a3.x+=c23.b.cx; a3.y+=c23.b.cy;
  }

  // 4) feed a portion of projection back to velocity (keeps consistency)
  const k = velFeedback/(dt*iters);
  p1.vx += a1.x*k; p1.vy += a1.y*k;
  p2.vx += a2.x*k; p2.vy += a2.y*k;
  p3.vx += a3.x*k; p3.vy += a3.y*k;

  // 5) second half-kick
  p1.vy += 0.5*g*dt; p2.vy += 0.5*g*dt; p3.vy += 0.5*g*dt;

  // clamp velocities
  [p1,p2,p3].forEach(p=>{const s=Math.hypot(p.vx,p.vy); if(s>vClamp){const f=vClamp/s; p.vx*=f; p.vy*=f;}});
}

/* ------------------------------- Rendering ------------------------------ */
function drawArm(ax,ay,bx,by,color,w=3){ tv.strokeStyle=color; tv.lineWidth=w; tv.beginPath(); tv.moveTo(ax,ay); tv.lineTo(bx,by); tv.stroke(); }
function dot(x,y,c,r=7){ tv.fillStyle=c; tv.beginPath(); tv.arc(x,y,r,0,Math.PI*2); tv.fill(); }

/* Trails added incrementally on the buffer (cheap) */
function addTrail(x,y,color){
  tt.strokeStyle = color; tt.lineWidth = 2;
  tt.globalAlpha = 0.65;
  tt.beginPath(); tt.moveTo(x,y); tt.lineTo(x+0.01,y+0.01); tt.stroke(); // tiny segment to deposit ink
  tt.globalAlpha = 1;
}

/* --------------------------- Main fixed-timestep ------------------------- */
let running = true;
const badge = $('stateBadge');
const toggleBtn = $('toggleBtn');
const resetBtn = $('resetBtn');
const randBtn = $('randBtn');
[toggleBtn,resetBtn,randBtn].forEach(b=>b.addEventListener('click',ripple));

function setRunning(val){
  running = val;
  toggleBtn.setAttribute('aria-pressed', String(val));
  badge.textContent = val ? 'RUNNING' : 'PAUSED';
  badge.className = 'status ' + (val?'play':'pause');
}
toggleBtn.addEventListener('click',()=>setRunning(!running));
resetBtn.addEventListener('click',()=>reset());
randBtn.addEventListener('click',()=>randomise());
window.addEventListener('keydown',e=>{
  if(e.key===' '||e.key==='Enter'){ e.preventDefault(); setRunning(!running); }
  if(e.key==='r'||e.key==='R') reset();
  if(e.key==='a'||e.key==='A') randomise();
});

function clearView(){ tv.fillStyle=BG; tv.fillRect(0,0,view.width/DPR, view.height/DPR); }

reset(); // initial state

let acc = 0;               // time accumulator (seconds)
let last = performance.now()/1000;

function tick(){
  const now = performance.now()/1000;
  let frameDt = now - last; if (frameDt > 0.25) frameDt = 0.25; // clamp
  last = now;

  // accumulate time for fixed-size physics steps
  acc += frameDt * P.timeScale;
  const step = dtFixed;
  const stepsPerFrame = (P.subSteps|0)||1; // extra sub-steps for very smooth motion
  const micro = step/stepsPerFrame;

  if(running){
    while(acc >= micro){
      for(let i=0;i<stepsPerFrame;i++) substep(micro);
      // ink trails (after physics step)
      addTrail(p1.x,p1.y, 'rgba(34,211,238,0.25)');  // COL1 faded
      addTrail(p2.x,p2.y, 'rgba(96,165,250,0.25)');  // COL2 faded
      addTrail(p3.x,p3.y, 'rgba(244,114,182,0.25)'); // COL3 faded
      acc -= micro;
    }
  }

  // draw arms/bobs over the (persistent) trail buffer
  clearView();
  dot(pivot.x,pivot.y,'#e5e7eb',5);
  drawArm(pivot.x,pivot.y,p1.x,p1.y,COL1,3);
  drawArm(p1.x,p1.y,p2.x,p2.y,COL2,3);
  drawArm(p2.x,p2.y,p3.x,p3.y,COL3,3);
  dot(p1.x,p1.y,COL1); dot(p2.x,p2.y,COL2); dot(p3.x,p3.y,COL3);

  HUD.textContent = `g=${P.g.toFixed(0)} px/s¬≤  dt=${dtFixed.toFixed(4)}s  iters=${iters}  subSteps/frame=${P.subSteps}  time√ó=${P.timeScale.toFixed(2)}  DPR=${DPR}`;
  requestAnimationFrame(tick);
}
requestAnimationFrame(tick);
</script>
</body>
</html>
